import{n as l}from"../../nuclen-notify-BUkiVJnd.js";async function R(m,n,r=3){try{const s=await fetch(m,n);if(!s.ok)throw new Error(`Network response was not ok (HTTP ${s.status})`);return s}catch(s){if(r>0)return console.warn(`Retrying... (${r} attempts left)`),R(m,n,r-1);throw console.error("Max retries reached:",s),s}}async function oe(m){if(!window.nuclenAjax||!window.nuclenAjax.ajax_url)throw new Error("Missing nuclenAjax configuration (ajax_url).");if(!window.nuclenAjax.fetch_action)throw new Error("Missing fetch_action in nuclenAjax configuration.");const n=new FormData;return n.append("action",window.nuclenAjax.fetch_action),window.nuclenAjax.nonce&&n.append("security",window.nuclenAjax.nonce),m&&n.append("generation_id",m),await(await R(window.nuclenAjax.ajax_url,{method:"POST",body:n,credentials:"same-origin"})).json()}function ne({intervalMs:m=5e3,generationId:n,onProgress:r=(o,f)=>{},onComplete:s=o=>{},onError:d=o=>{}}){const o=setInterval(async()=>{var f;try{const e=await oe(n);if(!e.success){const v=e.message||((f=e.data)==null?void 0:f.message)||"Polling error";throw new Error(v)}const{processed:p,total:a,successCount:c=p,failCount:B,finalReport:g,results:x,workflow:j}=e.data;r(p,a),p>=a&&(clearInterval(o),s({processed:p,total:a,successCount:c,failCount:B,finalReport:g,results:x,workflow:j}))}catch(e){clearInterval(o),d(e.message)}},m)}async function te(m){var d;if(!window.nuclenAdminVars||!window.nuclenAdminVars.ajax_url)throw new Error("Missing WP Ajax config (nuclenAdminVars.ajax_url).");const n=new FormData;n.append("action","nuclen_trigger_generation"),n.append("payload",JSON.stringify(m)),n.append("security",((d=window.nuclenAjax)==null?void 0:d.nonce)??"");const r=await fetch(window.nuclenAdminVars.ajax_url,{method:"POST",body:n,credentials:"same-origin"});if(!r.ok)throw new Error(`Generation start failed: HTTP ${r.status}`);const s=await r.json();if(!s.success)throw typeof s.data=="object"&&s.data.message?new Error(s.data.message):s.message?new Error(s.message):new Error("Generation start failed (unknown error).");return s}document.addEventListener("click",async m=>{var d,o,f;const n=m.target;if(!(n instanceof HTMLElement))return;const r=((d=window.nuclenAdminVars)==null?void 0:d.rest_receive_content)||"/wp-json/nuclear-engagement/v1/receive-content",s=((o=window.nuclenAdminVars)==null?void 0:o.rest_nonce)||"";if(n.classList.contains("nuclen-generate-single")){const e=n,p=e.dataset.postId,a=e.dataset.workflow;if(!p||!a){l("Missing data attributes: postId or workflow not found.");return}e.disabled=!0,e.textContent="Generating...";try{const c=await te({nuclen_selected_post_ids:JSON.stringify([p]),nuclen_selected_generate_workflow:a}),B=((f=c.data)==null?void 0:f.generation_id)||c.generation_id||"gen_"+Math.random().toString(36).substring(2);ne({intervalMs:5e3,generationId:B,onProgress(){e.textContent="Generating..."},onComplete:async({results:g,workflow:x})=>{if(g&&typeof g=="object")try{const v=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":s},credentials:"include",body:JSON.stringify({workflow:x,results:g})}),S=await v.json();if(v.ok&&!S.code){console.log("Successfully stored single-generation results in WP:",S);const D=g[p];if(D){if(x==="quiz"){const{date:P,questions:y}=D,i=S.finalDate&&typeof S.finalDate=="string"?S.finalDate:P,b=document.querySelector('input[name="nuclen_quiz_data[date]"]');b&&(b.readOnly=!1,b.value=i||"",b.readOnly=!0),Array.isArray(y)&&y.forEach((w,k)=>{const O=`input[name="nuclen_quiz_data[questions][${k}][question]"]`,q=document.querySelector(O);q&&(q.value=w.question||""),Array.isArray(w.answers)&&w.answers.forEach((_,u)=>{const h=`input[name="nuclen_quiz_data[questions][${k}][answers][${u}]"]`,A=document.querySelector(h);A&&(A.value=_)});const F=`textarea[name="nuclen_quiz_data[questions][${k}][explanation]"]`,t=document.querySelector(F);t&&(t.value=w.explanation||"")}),e.textContent="Stored!"}else if(x==="summary"){const{date:P,summary:y}=D,i=S.finalDate&&typeof S.finalDate=="string"?S.finalDate:P,b=document.querySelector('input[name="nuclen_summary_data[date]"]');if(b&&(b.readOnly=!1,b.value=i||"",b.readOnly=!0),typeof window.tinymce<"u"){const w=window.tinymce.get("nuclen_summary_data_summary");if(w&&typeof w.setContent=="function")w.setContent(y||""),w.save();else{const k=document.querySelector('textarea[name="nuclen_summary_data[summary]"]');k&&(k.value=y||"")}}else{const w=document.querySelector('textarea[name="nuclen_summary_data[summary]"]');w&&(w.value=y||"")}e.textContent="Stored!"}}}else console.error("Error storing single-generation results in WP:",S),e.textContent="Generation failed!";e.disabled=!1}catch(j){console.error("Fetch error calling /receive-content endpoint:",j),e.textContent="Generation failed!",e.disabled=!1}else e.textContent="Done (no data)!",e.disabled=!1},onError(g){g.includes("Invalid API key")?l("Your API key is invalid. Please go to the Setup page and enter a new one."):g.includes("Invalid WP App Password")?l("Your WP App Password is invalid. Please go to the Setup page and re-generate it."):g.includes("Not enough credits")?l("Not enough credits for single-post generation."):l("Error: "+g),e.textContent="Generate",e.disabled=!1}})}catch(c){c.message.includes("Invalid API key")?l("Your API key is invalid. Please go to the Setup page and enter a new one."):c.message.includes("Invalid WP App Password")?l("Your WP App Password is invalid. Please go to the Setup page and re-generate it."):c.message.includes("Not enough credits")?l("Not enough credits for single-post generation. Please top up first."):l("Error starting single generation: "+c.message),e.textContent="Generate",e.disabled=!1}}});(function(){var q,F;const n=document.getElementById("nuclen-step-1"),r=document.getElementById("nuclen-step-2"),s=document.getElementById("nuclen-updates-section"),d=document.getElementById("nuclen-updates-content"),o=document.getElementById("nuclen-restart-btn"),f=document.getElementById("nuclen-get-posts-btn"),e=document.getElementById("nuclen-go-back-btn"),p=document.getElementById("nuclen-generate-form"),a=document.getElementById("nuclen-submit-btn"),c=document.getElementById("nuclen-posts-count"),B=document.getElementById("nuclen-step-bar-1"),g=document.getElementById("nuclen-step-bar-2"),x=document.getElementById("nuclen-step-bar-3"),j=document.getElementById("nuclen-step-bar-4"),v=document.getElementById("nuclen-credits-info"),S=((q=window.nuclenAdminVars)==null?void 0:q.rest_receive_content)||"/wp-json/nuclear-engagement/v1/receive-content",D=((F=window.nuclenAdminVars)==null?void 0:F.rest_nonce)||"";function P(t){t&&t.classList.remove("nuclen-hidden")}function y(t){t&&t.classList.add("nuclen-hidden")}function i(t,_){t&&(t.classList.remove("nuclen-step-todo","nuclen-step-current","nuclen-step-done","nuclen-step-failed"),t.classList.add(`nuclen-step-${_}`))}P(n),y(r),y(s),y(o),i(B,"current"),i(g,"todo"),i(x,"todo"),i(j,"todo");async function b(){var h;if(!window.nuclenAjax||!window.nuclenAjax.ajax_url)throw new Error("Missing nuclenAjax configuration (ajax_url).");if(!window.nuclenAjax.fetch_action)throw new Error("Missing fetch_action in nuclenAjax configuration.");const t=new FormData;t.append("action",window.nuclenAjax.fetch_action),window.nuclenAjax.nonce&&t.append("security",window.nuclenAjax.nonce);const u=await(await R(window.nuclenAjax.ajax_url,{method:"POST",body:t,credentials:"same-origin"})).json();if(!u.success)throw new Error(((h=u.data)==null?void 0:h.message)||"Failed to fetch credits from SaaS");if(typeof u.data.remaining_credits=="number")return u.data.remaining_credits;throw new Error("No 'remaining_credits' in response")}f==null||f.addEventListener("click",()=>{var C;if(!window.nuclenAjax||!window.nuclenAjax.ajax_url){l("Error: Ajax is not configured properly. Please check the plugin settings.");return}c&&(c.innerText="Loading posts...");const t=new FormData;t.append("action","nuclen_get_posts_count"),(C=window.nuclenAjax)!=null&&C.nonce&&t.append("security",window.nuclenAjax.nonce);const _=document.getElementById("nuclen_post_status"),u=document.getElementById("nuclen_category"),h=document.getElementById("nuclen_author"),A=document.getElementById("nuclen_post_type"),I=document.getElementById("nuclen_generate_workflow"),T=document.getElementById("nuclen_allow_regenerate_data"),N=document.getElementById("nuclen_regenerate_protected_data");t.append("nuclen_post_status",_?_.value:""),t.append("nuclen_category",u?u.value:""),t.append("nuclen_author",h?h.value:""),t.append("nuclen_post_type",A?A.value:""),t.append("nuclen_generate_workflow",I?I.value:""),t.append("nuclen_allow_regenerate_data",T&&T.checked?"1":"0"),t.append("nuclen_regenerate_protected_data",N&&N.checked?"1":"0"),R(window.nuclenAjax.ajax_url||"",{method:"POST",body:t,credentials:"same-origin"}).then(E=>E.json()).then(async E=>{var Z;if(!E.success){c&&(c.innerText="Error retrieving post count."),(Z=E.data)!=null&&Z.message&&(E.data.message.includes("Invalid API key")?l("Your Gold Code (API key) is invalid. Please create a new one on the NE app and enter it on the plugin Setup page."):E.data.message.includes("Invalid WP App Password")?l("Your WP App Password is invalid. Please go to the plugin Setup page and re-generate it."):l(E.data.message));return}const L=E.data.count,W=E.data.post_ids,V=document.getElementById("nuclen_selected_post_ids");V&&(V.value=JSON.stringify(W));const Y=document.getElementById("nuclen_generate_workflow"),G=document.getElementById("nuclen_selected_generate_workflow");G&&Y&&(G.value=Y.value);const M=document.getElementById("nuclen_summary_format"),U=document.getElementById("nuclen_summary_length"),z=document.getElementById("nuclen_summary_number_of_items"),J=document.getElementById("nuclen_selected_summary_format"),H=document.getElementById("nuclen_selected_summary_length"),X=document.getElementById("nuclen_selected_summary_number_of_items");M&&J&&(J.value=M.value),U&&H&&(H.value=U.value),z&&X&&(X.value=z.value);const Q=document.getElementById("nuclen_selected_post_status");Q&&_&&(Q.value=_.value);const K=document.getElementById("nuclen_selected_post_type");if(K&&A&&(K.value=A.value),y(n),P(r),i(B,"done"),i(g,"current"),L===0){c&&(c.innerText="No posts found with these filters."),a&&y(a);return}c&&(c.innerText=`Number of posts to process: ${L}`);try{const $=await b(),ee=L;v&&(v.textContent=`This will consume ${ee} credit(s). You have ${$} left.`),$<ee?(l("Not enough credits. Please top up or reduce the number of posts."),a&&(a.disabled=!0)):a&&(P(a),a.disabled=!1)}catch($){console.error("Error fetching remaining credits:",$),v&&(v.textContent=`Unable to retrieve your credits: ${$.message}`),a&&(a.disabled=!1)}}).catch(E=>{console.error("Error retrieving post count:",E),c&&(c.innerText="Error retrieving post count. Please try again later.")})}),e==null||e.addEventListener("click",()=>{y(r),P(n),c&&(c.innerText=""),v&&(v.textContent=""),i(B,"current"),i(g,"todo")}),p==null||p.addEventListener("submit",async t=>{var _;if(t.preventDefault(),!window.nuclenAdminVars||!window.nuclenAdminVars.ajax_url){l("Error: WP Ajax config not found. Please check the plugin settings.");return}i(g,"done"),i(x,"current"),P(s),d&&(d.innerText="Processing posts... Do NOT leave this page until the process is complete."),y(r),a&&(a.disabled=!0);try{const u=Object.fromEntries(new FormData(p).entries()),h=await te(u),A=((_=h.data)==null?void 0:_.generation_id)||h.generation_id||"gen_"+Math.random().toString(36).substring(2);ne({intervalMs:5e3,generationId:A,onProgress:(I,T)=>{const N=I===void 0?0:I,C=T===void 0?"":T;d&&(d.innerText=`Processed ${N} of ${C} posts so far...`)},onComplete:async({failCount:I,finalReport:T,results:N,workflow:C})=>{if(i(x,"done"),i(j,"current"),N&&typeof N=="object")try{const L=await fetch(S,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":D},credentials:"include",body:JSON.stringify({workflow:C,results:N})}),W=await L.json();L.ok&&!W.code?console.log("Bulk content stored in WP meta successfully:",W):console.error("Error storing bulk content in WP meta:",W)}catch(E){console.error("Error storing bulk content in WP meta:",E)}d&&(I&&T?(d.innerText=`Some posts failed. ${T.message||""}`,i(j,"failed")):(d.innerText="All posts processed successfully! Your content has been saved.",i(j,"done"))),a&&(a.disabled=!1),P(o)},onError:I=>{i(x,"failed"),I.includes("Invalid API key")?l("Your API key is invalid. Please go to the Setup page and enter a new one."):I.includes("Invalid WP App Password")?l("Your WP App Password is invalid. Please re-generate it on the Setup page."):I.includes("Not enough credits")?l("Not enough credits. Please top up your account or reduce the number of posts."):l(`Error: ${I}`),d&&(d.innerText=`Error: ${I}`),a&&(a.disabled=!1),P(o)}})}catch(u){i(x,"failed"),u.message.includes("Invalid API key")?l("Your API key is invalid. Please go to the Setup page and enter a new one."):u.message.includes("Invalid WP App Password")?l("Your WP App Password is invalid. Please go to the Setup page and re-generate it."):u.message.includes("Not enough credits")?l("Not enough credits. Please top up or reduce posts."):l(`Error starting generation: ${u.message}`),a&&(a.disabled=!1),P(o)}});function w(){const t=document.getElementById("nuclen_generate_workflow"),_=document.getElementById("nuclen-summary-settings"),u=document.getElementById("nuclen-summary-paragraph-options"),h=document.getElementById("nuclen-summary-bullet-options"),A=document.getElementById("nuclen_summary_format");!t||!_||!u||!h||!A||(t.value==="summary"?(_.classList.remove("nuclen-hidden"),A.value==="paragraph"?(u.classList.remove("nuclen-hidden"),h.classList.add("nuclen-hidden")):(u.classList.add("nuclen-hidden"),h.classList.remove("nuclen-hidden"))):(_.classList.add("nuclen-hidden"),u.classList.add("nuclen-hidden"),h.classList.add("nuclen-hidden")))}w();const k=document.getElementById("nuclen_generate_workflow"),O=document.getElementById("nuclen_summary_format");k==null||k.addEventListener("change",w),O==null||O.addEventListener("change",w),o==null||o.addEventListener("click",()=>{y(s),y(o),y(r),c&&(c.innerText=""),v&&(v.textContent=""),P(n),i(B,"current"),i(g,"todo"),i(x,"todo"),i(j,"todo")})})();document.addEventListener("DOMContentLoaded",()=>{const m=document.querySelectorAll(".nav-tab"),n=document.querySelectorAll(".nuclen-tab-content");m.forEach(o=>{o.addEventListener("click",f=>{f.preventDefault();const e=o.getAttribute("href");if(!e)return;m.forEach(a=>a.classList.remove("nav-tab-active")),o.classList.add("nav-tab-active"),n.forEach(a=>{a.style.display="none"});const p=document.querySelector(e);p&&(p.style.display="block")})}),typeof wp<"u"&&typeof wp.wpColorPicker=="function"&&document.querySelectorAll(".wp-color-picker-field").forEach(o=>{wp.wpColorPicker.call(o)});const r=document.getElementById("nuclen-custom-theme-section"),s=document.querySelectorAll("input[name='nuclen_theme']");function d(){const o=document.querySelector("input[name='nuclen_theme']:checked");if(!o||!r)return;o.value==="custom"?r.classList.remove("nuclen-hidden"):r.classList.add("nuclen-hidden")}s.forEach(o=>{o.addEventListener("change",d)}),d()});(function(m){m(document).ready(()=>{const n=window.nePointerData;if(!n||!n.pointers||n.pointers.length===0)return;let r=0;const s=n.pointers,d=n.ajaxurl,o=n.nonce;function f(){if(r>=s.length)return;const e=s[r],p=m(e.target);if(!p.length){r++,f();return}p.pointer({content:`<h3>${e.title}</h3><p>${e.content}</p>`,position:e.position,close:()=>{m.post(d,{action:"nuclen_dismiss_pointer",pointer:e.id,nonce:o}),r++,f()}}).pointer("open")}f()})})(window.jQuery);
