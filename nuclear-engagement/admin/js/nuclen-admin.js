function C(...e){console.log(...e)}function A(...e){console.warn(...e)}function h(...e){console.error(...e)}async function b(e,t,n=3,r=500){let c=0,a=r,o;for(;c<=n;){try{const i=await fetch(e,t),{status:s,ok:u}=i,l=await i.text().catch(()=>"");let d=null;if(l)try{d=JSON.parse(l)}catch{}return u?{ok:!0,status:s,data:d}:{ok:!1,status:s,data:d,error:l}}catch(i){if(o=i,c===n)break;A(`Retrying request to ${e} with method ${t.method||"GET"} (${n-c} attempts left). Error: ${o.message}`,o),await new Promise(s=>setTimeout(s,a)),a*=2}c+=1}throw h(`Max retries reached for ${e} with method ${t.method||"GET"}:`,o),o}async function T(e){if(!window.nuclenAjax||!window.nuclenAjax.ajax_url)throw new Error("Missing nuclenAjax configuration (ajax_url).");if(!window.nuclenAjax.fetch_action)throw new Error("Missing fetch_action in nuclenAjax configuration.");const t=new FormData;t.append("action",window.nuclenAjax.fetch_action),window.nuclenAjax.nonce&&t.append("security",window.nuclenAjax.nonce),e&&t.append("generation_id",e);const n=await b(window.nuclenAjax.ajax_url,{method:"POST",body:t,credentials:"same-origin"});if(!n.ok)throw new Error(n.error||`HTTP ${n.status}`);return n.data}async function S(e){var c,a;if(!window.nuclenAdminVars||!window.nuclenAdminVars.ajax_url)throw new Error("Missing WP Ajax config (nuclenAdminVars.ajax_url).");const t=new FormData;if(t.append("action","nuclen_trigger_generation"),t.append("payload",JSON.stringify(e)),!((c=window.nuclenAjax)!=null&&c.nonce))throw new Error("Missing security nonce.");t.append("security",window.nuclenAjax.nonce);const n=await b(window.nuclenAdminVars.ajax_url,{method:"POST",body:t,credentials:"same-origin"});if(!n.ok)throw new Error(n.error||`HTTP ${n.status}`);const r=n.data;if(!(r!=null&&r.success)){const o=(r==null?void 0:r.message)||((a=r==null?void 0:r.data)==null?void 0:a.message)||"Generation start failed (unknown error).";throw new Error(o)}return r}function k({intervalMs:e=5e3,generationId:t,onProgress:n=(a,o)=>{},onComplete:r=a=>{},onError:c=a=>{}}){const a=setInterval(async()=>{var o;try{const i=await T(t);if(!i.success){const E=i.message||((o=i.data)==null?void 0:o.message)||"Polling error";throw new Error(E)}const{processed:s,total:u,successCount:l=s,failCount:d,finalReport:p,results:g,workflow:w}=i.data;n(s,u),s>=u&&(clearInterval(a),r({processed:s,total:u,successCount:l,failCount:d,finalReport:p,results:g,workflow:w}))}catch(i){clearInterval(a),c(i.message)}},e)}function f(e){const t=document.createElement("div");t.className="nuclen-error-toast",t.textContent=e,document.body.appendChild(t),setTimeout(()=>t.remove(),5e3),console.error(e)}var x;const j=((x=window.nuclenAdminVars)==null?void 0:x.rest_receive_content)||"/wp-json/nuclear-engagement/v1/receive-content";var I;const L=((I=window.nuclenAdminVars)==null?void 0:I.rest_nonce)||"";function B(e){const t=e.replace(/<[^>]+>/g,"");t.includes("Invalid API key")?f("Your API key is invalid. Please go to the Setup page and enter a new one."):t.includes("Invalid WP App Password")?f("Your WP App Password is invalid. Please re-generate it on the Setup page."):t.includes("Not enough credits")?f("Not enough credits. Please top up your account or reduce the number of posts."):f(`Error: ${t}`)}async function P(e,t){const n={workflow:e,results:t};let r;try{r=await fetch(j,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":L},credentials:"include",body:JSON.stringify(n)})}catch(a){return h("Fetch failed in nuclenStoreGenerationResults:",a),f("Network error"),{ok:!1,data:{message:"Network error"}}}let c=null;if(r.ok)try{c=await r.json()}catch{return{ok:!1,data:{message:"Invalid JSON"}}}return{ok:r.ok,data:c}}function N(e,t){const{date:n,questions:r}=e,c=t||n,a=document.querySelector('input[name="nuclen_quiz_data[date]"]');a&&(a.readOnly=!1,a.value=c||"",a.readOnly=!0),Array.isArray(r)&&r.forEach((o,i)=>{const s=`input[name="nuclen_quiz_data[questions][${i}][question]"]`,u=document.querySelector(s);u&&(u.value=o.question||""),Array.isArray(o.answers)&&o.answers.forEach((p,g)=>{const w=`input[name="nuclen_quiz_data[questions][${i}][answers][${g}]"]`,E=document.querySelector(w);E&&(E.value=p)});const l=`textarea[name="nuclen_quiz_data[questions][${i}][explanation]"]`,d=document.querySelector(l);d&&(d.value=o.explanation||"")})}function O(e,t){const{date:n,summary:r}=e,c=t||n,a=document.querySelector('input[name="nuclen_summary_data[date]"]');if(a&&(a.readOnly=!1,a.value=c||"",a.readOnly=!0),typeof window.tinymce<"u"){const o=window.tinymce.get("nuclen_summary_data_summary");if(o&&typeof o.setContent=="function")o.setContent(r||""),o.save();else{const i=document.querySelector('textarea[name="nuclen_summary_data[summary]"]');i&&(i.value=r||"")}}else{const o=document.querySelector('textarea[name="nuclen_summary_data[summary]"]');o&&(o.value=r||"")}}function $(){document.addEventListener("click",async e=>{var a;const t=e.target;if(!(t instanceof HTMLElement)||!t.classList.contains("nuclen-generate-single"))return;const n=t,r=n.dataset.postId,c=n.dataset.workflow;if(!r||!c){f("Missing data attributes: postId or workflow not found.");return}n.disabled=!0,n.textContent="Generating...";try{const o=await S({nuclen_selected_post_ids:JSON.stringify([r]),nuclen_selected_generate_workflow:c}),i=((a=o.data)==null?void 0:a.generation_id)||o.generation_id||"gen_"+Math.random().toString(36).substring(2);k({intervalMs:5e3,generationId:i,onProgress(){n.textContent="Generating..."},async onComplete({results:s,workflow:u}){if(s&&typeof s=="object")try{const{ok:l,data:d}=await P(u,s);if(l&&!d.code){const p=s[r],g=d.finalDate&&typeof d.finalDate=="string"?d.finalDate:void 0;p&&(u==="quiz"?N(p,g):u==="summary"&&O(p,g)),n.textContent="Stored!"}else h("Error storing single-generation results in WP:",d),n.textContent="Generation failed!"}catch(l){h("Fetch error calling /receive-content endpoint:",l),n.textContent="Generation failed!"}else n.textContent="Done (no data)!";n.disabled=!1},onError(s){B(s),n.textContent="Generate",n.disabled=!1}})}catch(o){B(o.message),n.textContent="Generate",n.disabled=!1}})}$();function F(){return{step1:document.getElementById("nuclen-step-1"),step2:document.getElementById("nuclen-step-2"),updatesSection:document.getElementById("nuclen-updates-section"),updatesContent:document.getElementById("nuclen-updates-content"),restartBtn:document.getElementById("nuclen-restart-btn"),getPostsBtn:document.getElementById("nuclen-get-posts-btn"),goBackBtn:document.getElementById("nuclen-go-back-btn"),generateForm:document.getElementById("nuclen-generate-form"),submitBtn:document.getElementById("nuclen-submit-btn"),postsCountEl:document.getElementById("nuclen-posts-count"),stepBar1:document.getElementById("nuclen-step-bar-1"),stepBar2:document.getElementById("nuclen-step-bar-2"),stepBar3:document.getElementById("nuclen-step-bar-3"),stepBar4:document.getElementById("nuclen-step-bar-4"),creditsInfoEl:document.getElementById("nuclen-credits-info")}}function y(e){e&&e.classList.remove("nuclen-hidden")}function _(e){e&&e.classList.add("nuclen-hidden")}function m(e,t){e&&(e.classList.remove("nuclen-step-todo","nuclen-step-current","nuclen-step-done","nuclen-step-failed"),e.classList.add(`nuclen-step-${t}`))}async function q(){var r;if(!window.nuclenAjax||!window.nuclenAjax.ajax_url)throw new Error("Missing nuclenAjax configuration (ajax_url).");if(!window.nuclenAjax.fetch_action)throw new Error("Missing fetch_action in nuclenAjax configuration.");const e=new FormData;e.append("action",window.nuclenAjax.fetch_action),window.nuclenAjax.nonce&&e.append("security",window.nuclenAjax.nonce);const t=await b(window.nuclenAjax.ajax_url,{method:"POST",body:e,credentials:"same-origin"});if(!t.ok)throw new Error(t.error||`HTTP ${t.status}`);const n=t.data;if(!n.success)throw new Error(n.message||((r=n.data)==null?void 0:r.message)||"Failed to fetch credits from SaaS");if(typeof n.data.remaining_credits=="number")return n.data.remaining_credits;throw new Error("No 'remaining_credits' in response")}function v(){const e=document.getElementById("nuclen_generate_workflow"),t=document.getElementById("nuclen-summary-settings"),n=document.getElementById("nuclen-summary-paragraph-options"),r=document.getElementById("nuclen-summary-bullet-options"),c=document.getElementById("nuclen_summary_format");!e||!t||!n||!r||!c||(e.value==="summary"?(t.classList.remove("nuclen-hidden"),c.value==="paragraph"?(n.classList.remove("nuclen-hidden"),r.classList.add("nuclen-hidden")):(n.classList.add("nuclen-hidden"),r.classList.remove("nuclen-hidden"))):(t.classList.add("nuclen-hidden"),n.classList.add("nuclen-hidden"),r.classList.add("nuclen-hidden")))}function M(){const e=document.getElementById("nuclen_post_status"),t=document.getElementById("nuclen_category"),n=document.getElementById("nuclen_author"),r=document.getElementById("nuclen_post_type"),c=document.getElementById("nuclen_generate_workflow"),a=document.getElementById("nuclen_allow_regenerate_data"),o=document.getElementById("nuclen_regenerate_protected_data"),i=document.getElementById("nuclen_summary_format"),s=document.getElementById("nuclen_summary_length"),u=document.getElementById("nuclen_summary_number_of_items");return{postStatus:e?e.value:"",category:t?t.value:"",author:n?n.value:"",postType:r?r.value:"",workflow:c?c.value:"",allowRegenerate:!!a&&a.checked,regenerateProtected:!!o&&o.checked,summaryFormat:i?i.value:"",summaryLength:s?s.value:"",summaryNumberOfItems:u?u.value:""}}function D(e,t){e.append("nuclen_post_status",t.postStatus),e.append("nuclen_category",t.category),e.append("nuclen_author",t.author),e.append("nuclen_post_type",t.postType),e.append("nuclen_generate_workflow",t.workflow),e.append("nuclen_allow_regenerate_data",t.allowRegenerate?"1":"0"),e.append("nuclen_regenerate_protected_data",t.regenerateProtected?"1":"0"),e.append("nuclen_summary_format",t.summaryFormat),e.append("nuclen_summary_length",t.summaryLength),e.append("nuclen_summary_number_of_items",t.summaryNumberOfItems)}function R(e){const t=document.getElementById("nuclen_selected_generate_workflow"),n=document.getElementById("nuclen_selected_summary_format"),r=document.getElementById("nuclen_selected_summary_length"),c=document.getElementById("nuclen_selected_summary_number_of_items"),a=document.getElementById("nuclen_selected_post_status"),o=document.getElementById("nuclen_selected_post_type");t&&(t.value=e.workflow),n&&(n.value=e.summaryFormat),r&&(r.value=e.summaryLength),c&&(c.value=e.summaryNumberOfItems),a&&(a.value=e.postStatus),o&&(o.value=e.postType)}function G(e){var t;(t=e.getPostsBtn)==null||t.addEventListener("click",async()=>{var u,l;if(!window.nuclenAjax||!window.nuclenAjax.ajax_url){f("Error: Ajax is not configured properly. Please check the plugin settings.");return}e.postsCountEl&&(e.postsCountEl.innerText="Loading posts...");const n=new FormData;n.append("action","nuclen_get_posts_count"),(u=window.nuclenAjax)!=null&&u.nonce&&n.append("security",window.nuclenAjax.nonce);const r=M();D(n,r);const c=await b(window.nuclenAjax.ajax_url||"",{method:"POST",body:n,credentials:"same-origin"});if(!c.ok){h("Error retrieving post count:",c.error),e.postsCountEl&&(e.postsCountEl.innerText="Error retrieving post count.");return}const a=c.data;if(!a.success){e.postsCountEl&&(e.postsCountEl.innerText="Error retrieving post count.");const d=a.message||((l=a.data)==null?void 0:l.message);d&&(d.includes("Invalid API key")?f("Your Gold Code (API key) is invalid. Please create a new one on the NE app and enter it on the plugin Setup page."):d.includes("Invalid WP App Password")?f("Your WP App Password is invalid. Please go to the plugin Setup page and re-generate it."):f(d));return}const o=a.data.count,i=a.data.post_ids,s=document.getElementById("nuclen_selected_post_ids");if(s&&(s.value=JSON.stringify(i)),R(r),_(e.step1),y(e.step2),m(e.stepBar1,"done"),m(e.stepBar2,"current"),o===0){e.postsCountEl&&(e.postsCountEl.innerText="No posts found with these filters."),e.submitBtn&&_(e.submitBtn);return}e.postsCountEl&&(e.postsCountEl.innerText=`Number of posts to process: ${o}`);try{const d=await q(),p=o;e.creditsInfoEl&&(e.creditsInfoEl.textContent=`This will consume ${p} credit(s). You have ${d} left.`),d<p?(f("Not enough credits. Please top up or reduce the number of posts."),e.submitBtn&&(e.submitBtn.disabled=!0)):e.submitBtn&&(y(e.submitBtn),e.submitBtn.disabled=!1)}catch(d){h("Error fetching remaining credits:",d),e.creditsInfoEl&&(e.creditsInfoEl.textContent=`Unable to retrieve your credits: ${d.message}`),e.submitBtn&&(e.submitBtn.disabled=!1)}})}function W(e){var t;(t=e.generateForm)==null||t.addEventListener("submit",async n=>{var r;if(n.preventDefault(),!window.nuclenAdminVars||!window.nuclenAdminVars.ajax_url){f("Error: WP Ajax config not found. Please check the plugin settings.");return}m(e.stepBar2,"done"),m(e.stepBar3,"current"),y(e.updatesSection),e.updatesContent&&(e.updatesContent.innerText="Processing posts... Do NOT leave this page until the process is complete."),_(e.step2),e.submitBtn&&(e.submitBtn.disabled=!0);try{const c=Object.fromEntries(new FormData(e.generateForm).entries()),a=await S(c),o=((r=a.data)==null?void 0:r.generation_id)||a.generation_id||"gen_"+Math.random().toString(36).substring(2);k({intervalMs:5e3,generationId:o,onProgress:(i,s)=>{const u=i===void 0?0:i,l=s===void 0?"":s;e.updatesContent&&(e.updatesContent.innerText=`Processed ${u} of ${l} posts so far...`)},onComplete:async({failCount:i,finalReport:s,results:u,workflow:l})=>{if(m(e.stepBar3,"done"),m(e.stepBar4,"current"),u&&typeof u=="object")try{const{ok:d,data:p}=await P(l,u);d&&!p.code?C("Bulk content stored in WP meta successfully:",p):h("Error storing bulk content in WP meta:",p)}catch(d){h("Error storing bulk content in WP meta:",d)}e.updatesContent&&(i&&s?(e.updatesContent.innerText=`Some posts failed. ${s.message||""}`,m(e.stepBar4,"failed")):(e.updatesContent.innerText="All posts processed successfully! Your content has been saved.",m(e.stepBar4,"done"))),e.submitBtn&&(e.submitBtn.disabled=!1),y(e.restartBtn)},onError:i=>{m(e.stepBar3,"failed"),B(i),e.updatesContent&&(e.updatesContent.innerText=`Error: ${i}`),e.submitBtn&&(e.submitBtn.disabled=!1),y(e.restartBtn)}})}catch(c){m(e.stepBar3,"failed"),B(c.message),e.submitBtn&&(e.submitBtn.disabled=!1),y(e.restartBtn)}})}function V(e){var t;(t=e.goBackBtn)==null||t.addEventListener("click",()=>{_(e.step2),y(e.step1),e.postsCountEl&&(e.postsCountEl.innerText=""),e.creditsInfoEl&&(e.creditsInfoEl.textContent=""),m(e.stepBar1,"current"),m(e.stepBar2,"todo")})}function z(e){var t;(t=e.restartBtn)==null||t.addEventListener("click",()=>{_(e.updatesSection),_(e.restartBtn),_(e.step2),e.postsCountEl&&(e.postsCountEl.innerText=""),e.creditsInfoEl&&(e.creditsInfoEl.textContent=""),y(e.step1),m(e.stepBar1,"current"),m(e.stepBar2,"todo"),m(e.stepBar3,"todo"),m(e.stepBar4,"todo")})}function H(){v();const e=document.getElementById("nuclen_generate_workflow"),t=document.getElementById("nuclen_summary_format");e==null||e.addEventListener("change",v),t==null||t.addEventListener("change",v)}function Y(){const e=F();e.step1&&e.step1.classList.remove("nuclen-hidden"),e.step2&&e.step2.classList.add("nuclen-hidden"),e.updatesSection&&e.updatesSection.classList.add("nuclen-hidden"),e.restartBtn&&e.restartBtn.classList.add("nuclen-hidden"),e.stepBar1&&e.stepBar1.classList.add("nuclen-step-current"),e.stepBar2&&e.stepBar2.classList.add("nuclen-step-todo"),e.stepBar3&&e.stepBar3.classList.add("nuclen-step-todo"),e.stepBar4&&e.stepBar4.classList.add("nuclen-step-todo"),G(e),W(e),V(e),z(e),H()}Y();document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelectorAll(".nav-tab"),t=document.querySelectorAll(".nuclen-tab-content");e.forEach(a=>{a.addEventListener("click",o=>{o.preventDefault();const i=a.getAttribute("href");if(!i)return;e.forEach(u=>u.classList.remove("nav-tab-active")),a.classList.add("nav-tab-active"),t.forEach(u=>{u.style.display="none"});const s=document.querySelector(i);s&&(s.style.display="block")})});const n=document.getElementById("nuclen-custom-theme-section"),r=document.querySelectorAll("input[name='nuclen_theme']");function c(){const a=document.querySelector("input[name='nuclen_theme']:checked");if(!a||!n)return;a.value==="custom"?n.classList.remove("nuclen-hidden"):n.classList.add("nuclen-hidden")}r.forEach(a=>{a.addEventListener("change",c)}),c()});(function(){document.addEventListener("DOMContentLoaded",()=>{const e=window.nePointerData;if(!e||!e.pointers||e.pointers.length===0)return;let t=0;const n=e.pointers,r=e.ajaxurl,c=e.nonce;function a(){if(t>=n.length)return;const o=n[t],i=document.querySelector(o.target);if(!i){t++,a();return}const s=document.createElement("div");s.className=`wp-pointer pointer-${o.position.edge}`,s.style.position="absolute",s.innerHTML=`
        <div class="wp-pointer-content">
          <h3>${o.title}</h3>
          <p>${o.content}</p>
          <a class="close" href="#">Dismiss</a>
        </div>
      `,document.body.appendChild(s);const u=i.getBoundingClientRect();let l=window.scrollY+u.top,d=window.scrollX+u.left;switch(o.position.edge){case"top":l-=s.offsetHeight;break;case"bottom":l+=u.height;break;case"left":d-=s.offsetWidth;break;case"right":d+=u.width;break}o.position.align==="center"?o.position.edge==="top"||o.position.edge==="bottom"?d+=(u.width-s.offsetWidth)/2:l+=(u.height-s.offsetHeight)/2:(o.position.align==="right"||o.position.align==="bottom")&&(o.position.edge==="top"||o.position.edge==="bottom"?d+=u.width-s.offsetWidth:l+=u.height-s.offsetHeight),s.style.top=`${Math.max(l,0)}px`,s.style.left=`${Math.max(d,0)}px`;const p=s.querySelector(".close");p==null||p.addEventListener("click",g=>{g.preventDefault();const w=new URLSearchParams;w.append("action","nuclen_dismiss_pointer"),w.append("pointer",o.id),c&&w.append("nonce",c),fetch(r,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:w.toString()}),s.remove(),t++,a()})}a()})})();(function(){if(!window.wp||!window.wp.blocks||!window.wp.element||!window.wp.i18n)return;const{registerBlockType:e}=window.wp.blocks,{createElement:t}=window.wp.element,{__:n}=window.wp.i18n;e("nuclear-engagement/quiz",{apiVersion:2,title:n("Quiz","nuclear-engagement"),icon:"editor-help",category:"widgets",edit:()=>t("p",null,n("Quiz will render on the front-end.","nuclear-engagement")),save:()=>null}),e("nuclear-engagement/summary",{apiVersion:2,title:n("Summary","nuclear-engagement"),icon:"excerpt-view",category:"widgets",edit:()=>t("p",null,n("Summary will render on the front-end.","nuclear-engagement")),save:()=>null})})();
