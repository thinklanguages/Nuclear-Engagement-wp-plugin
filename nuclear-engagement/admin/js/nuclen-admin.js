async function F(u,n,s=3){try{const a=await fetch(u,n);if(!a.ok)throw new Error(`Network response was not ok (HTTP ${a.status})`);return a}catch(a){if(s>0)return console.warn(`Retrying... (${s} attempts left)`),F(u,n,s-1);throw console.error("Max retries reached:",a),a}}async function te(u){if(!window.nuclenAjax||!window.nuclenAjax.ajax_url)throw new Error("Missing nuclenAjax configuration (ajax_url).");if(!window.nuclenAjax.fetch_action)throw new Error("Missing fetch_action in nuclenAjax configuration.");const n=new FormData;return n.append("action",window.nuclenAjax.fetch_action),window.nuclenAjax.nonce&&n.append("security",window.nuclenAjax.nonce),u&&n.append("generation_id",u),await(await F(window.nuclenAjax.ajax_url,{method:"POST",body:n,credentials:"same-origin"})).json()}function ee({intervalMs:u=5e3,generationId:n,onProgress:s=(o,p)=>{},onComplete:a=o=>{},onError:l=o=>{}}){const o=setInterval(async()=>{var p;try{const e=await te(n);if(!e.success){const E=e.message||((p=e.data)==null?void 0:p.message)||"Polling error";throw new Error(E)}const{processed:m,total:r,successCount:c=m,failCount:k,finalReport:f,results:P,workflow:b}=e.data;s(m,r),m>=r&&(clearInterval(o),a({processed:m,total:r,successCount:c,failCount:k,finalReport:f,results:P,workflow:b}))}catch(e){clearInterval(o),l(e.message)}},u)}async function ne(u){var l;if(!window.nuclenAdminVars||!window.nuclenAdminVars.ajax_url)throw new Error("Missing WP Ajax config (nuclenAdminVars.ajax_url).");const n=new FormData;n.append("action","nuclen_trigger_generation"),n.append("payload",JSON.stringify(u)),n.append("security",((l=window.nuclenAjax)==null?void 0:l.nonce)??"");const s=await fetch(window.nuclenAdminVars.ajax_url,{method:"POST",body:n,credentials:"same-origin"});if(!s.ok)throw new Error(`Generation start failed: HTTP ${s.status}`);const a=await s.json();if(!a.success)throw typeof a.data=="object"&&a.data.message?new Error(a.data.message):a.message?new Error(a.message):new Error("Generation start failed (unknown error).");return a}document.addEventListener("click",async u=>{var l,o,p;const n=u.target;if(!(n instanceof HTMLElement))return;const s=((l=window.nuclenAdminVars)==null?void 0:l.rest_receive_content)||"/wp-json/nuclear-engagement/v1/receive-content",a=((o=window.nuclenAdminVars)==null?void 0:o.rest_nonce)||"";if(n.classList.contains("nuclen-generate-single")){const e=n,m=e.dataset.postId,r=e.dataset.workflow;if(!m||!r){alert("Missing data attributes: postId or workflow not found.");return}e.disabled=!0,e.textContent="Generating...";try{const c=await ne({nuclen_selected_post_ids:JSON.stringify([m]),nuclen_selected_generate_workflow:r}),k=((p=c.data)==null?void 0:p.generation_id)||c.generation_id||"gen_"+Math.random().toString(36).substring(2);ee({intervalMs:5e3,generationId:k,onProgress(){e.textContent="Generating..."},onComplete:async({results:f,workflow:P})=>{if(f&&typeof f=="object")try{const E=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":a},credentials:"include",body:JSON.stringify({workflow:P,results:f})}),A=await E.json();if(E.ok&&!A.code){console.log("Successfully stored single-generation results in WP:",A);const L=f[m];if(L){if(P==="quiz"){const{date:I,questions:g}=L,i=A.finalDate&&typeof A.finalDate=="string"?A.finalDate:I,S=document.querySelector('input[name="nuclen_quiz_data[date]"]');S&&(S.readOnly=!1,S.value=i||"",S.readOnly=!0),Array.isArray(g)&&g.forEach((y,j)=>{const D=`input[name="nuclen_quiz_data[questions][${j}][question]"]`,O=document.querySelector(D);O&&(O.value=y.question||""),Array.isArray(y.answers)&&y.answers.forEach((w,d)=>{const _=`input[name="nuclen_quiz_data[questions][${j}][answers][${d}]"]`,x=document.querySelector(_);x&&(x.value=w)});const $=`textarea[name="nuclen_quiz_data[questions][${j}][explanation]"]`,t=document.querySelector($);t&&(t.value=y.explanation||"")}),e.textContent="Stored!"}else if(P==="summary"){const{date:I,summary:g}=L,i=A.finalDate&&typeof A.finalDate=="string"?A.finalDate:I,S=document.querySelector('input[name="nuclen_summary_data[date]"]');if(S&&(S.readOnly=!1,S.value=i||"",S.readOnly=!0),typeof window.tinymce<"u"){const y=window.tinymce.get("nuclen_summary_data_summary");if(y&&typeof y.setContent=="function")y.setContent(g||""),y.save();else{const j=document.querySelector('textarea[name="nuclen_summary_data[summary]"]');j&&(j.value=g||"")}}else{const y=document.querySelector('textarea[name="nuclen_summary_data[summary]"]');y&&(y.value=g||"")}e.textContent="Stored!"}}}else console.error("Error storing single-generation results in WP:",A),e.textContent="Generation failed!";e.disabled=!1}catch(b){console.error("Fetch error calling /receive-content endpoint:",b),e.textContent="Generation failed!",e.disabled=!1}else e.textContent="Done (no data)!",e.disabled=!1},onError(f){f.includes("Invalid API key")?alert("Your API key is invalid. Please go to the Setup page and enter a new one."):f.includes("Invalid WP App Password")?alert("Your WP App Password is invalid. Please go to the Setup page and re-generate it."):f.includes("Not enough credits")?alert("Not enough credits for single-post generation."):alert("Error: "+f),e.textContent="Generate",e.disabled=!1}})}catch(c){c.message.includes("Invalid API key")?alert("Your API key is invalid. Please go to the Setup page and enter a new one."):c.message.includes("Invalid WP App Password")?alert("Your WP App Password is invalid. Please go to the Setup page and re-generate it."):c.message.includes("Not enough credits")?alert("Not enough credits for single-post generation. Please top up first."):alert("Error starting single generation: "+c.message),e.textContent="Generate",e.disabled=!1}}});(function(){var O,$;const n=document.getElementById("nuclen-step-1"),s=document.getElementById("nuclen-step-2"),a=document.getElementById("nuclen-updates-section"),l=document.getElementById("nuclen-updates-content"),o=document.getElementById("nuclen-restart-btn"),p=document.getElementById("nuclen-get-posts-btn"),e=document.getElementById("nuclen-go-back-btn"),m=document.getElementById("nuclen-generate-form"),r=document.getElementById("nuclen-submit-btn"),c=document.getElementById("nuclen-posts-count"),k=document.getElementById("nuclen-step-bar-1"),f=document.getElementById("nuclen-step-bar-2"),P=document.getElementById("nuclen-step-bar-3"),b=document.getElementById("nuclen-step-bar-4"),E=document.getElementById("nuclen-credits-info"),A=((O=window.nuclenAdminVars)==null?void 0:O.rest_receive_content)||"/wp-json/nuclear-engagement/v1/receive-content",L=(($=window.nuclenAdminVars)==null?void 0:$.rest_nonce)||"";function I(t){t&&t.classList.remove("nuclen-hidden")}function g(t){t&&t.classList.add("nuclen-hidden")}function i(t,w){t&&(t.classList.remove("nuclen-step-todo","nuclen-step-current","nuclen-step-done","nuclen-step-failed"),t.classList.add(`nuclen-step-${w}`))}I(n),g(s),g(a),g(o),i(k,"current"),i(f,"todo"),i(P,"todo"),i(b,"todo");async function S(){var _;if(!window.nuclenAjax||!window.nuclenAjax.ajax_url)throw new Error("Missing nuclenAjax configuration (ajax_url).");if(!window.nuclenAjax.fetch_action)throw new Error("Missing fetch_action in nuclenAjax configuration.");const t=new FormData;t.append("action",window.nuclenAjax.fetch_action),window.nuclenAjax.nonce&&t.append("security",window.nuclenAjax.nonce);const d=await(await F(window.nuclenAjax.ajax_url,{method:"POST",body:t,credentials:"same-origin"})).json();if(!d.success)throw new Error(((_=d.data)==null?void 0:_.message)||"Failed to fetch credits from SaaS");if(typeof d.data.remaining_credits=="number")return d.data.remaining_credits;throw new Error("No 'remaining_credits' in response")}p==null||p.addEventListener("click",()=>{var N;if(!window.nuclenAjax||!window.nuclenAjax.ajax_url){alert("Error: Ajax is not configured properly. Please check the plugin settings.");return}c&&(c.innerText="Loading posts...");const t=new FormData;t.append("action","nuclen_get_posts_count"),(N=window.nuclenAjax)!=null&&N.nonce&&t.append("security",window.nuclenAjax.nonce);const w=document.getElementById("nuclen_post_status"),d=document.getElementById("nuclen_category"),_=document.getElementById("nuclen_author"),x=document.getElementById("nuclen_post_type"),v=document.getElementById("nuclen_generate_workflow"),B=document.getElementById("nuclen_allow_regenerate_data"),T=document.getElementById("nuclen_regenerate_protected_data");t.append("nuclen_post_status",w?w.value:""),t.append("nuclen_category",d?d.value:""),t.append("nuclen_author",_?_.value:""),t.append("nuclen_post_type",x?x.value:""),t.append("nuclen_generate_workflow",v?v.value:""),t.append("nuclen_allow_regenerate_data",B&&B.checked?"1":"0"),t.append("nuclen_regenerate_protected_data",T&&T.checked?"1":"0"),F(window.nuclenAjax.ajax_url||"",{method:"POST",body:t,credentials:"same-origin"}).then(h=>h.json()).then(async h=>{var K;if(!h.success){c&&(c.innerText="Error retrieving post count."),(K=h.data)!=null&&K.message&&(h.data.message.includes("Invalid API key")?alert("Your Gold Code (API key) is invalid. Please create a new one on the NE app and enter it on the plugin Setup page."):h.data.message.includes("Invalid WP App Password")?alert("Your WP App Password is invalid. Please go to the plugin Setup page and re-generate it."):alert(h.data.message));return}const C=h.data.count,q=h.data.post_ids,R=document.getElementById("nuclen_selected_post_ids");R&&(R.value=JSON.stringify(q));const V=document.getElementById("nuclen_generate_workflow"),Y=document.getElementById("nuclen_selected_generate_workflow");Y&&V&&(Y.value=V.value);const G=document.getElementById("nuclen_summary_format"),M=document.getElementById("nuclen_summary_length"),U=document.getElementById("nuclen_summary_number_of_items"),z=document.getElementById("nuclen_selected_summary_format"),J=document.getElementById("nuclen_selected_summary_length"),H=document.getElementById("nuclen_selected_summary_number_of_items");G&&z&&(z.value=G.value),M&&J&&(J.value=M.value),U&&H&&(H.value=U.value);const X=document.getElementById("nuclen_selected_post_status");X&&w&&(X.value=w.value);const Q=document.getElementById("nuclen_selected_post_type");if(Q&&x&&(Q.value=x.value),g(n),I(s),i(k,"done"),i(f,"current"),C===0){c&&(c.innerText="No posts found with these filters."),r&&g(r);return}c&&(c.innerText=`Number of posts to process: ${C}`);try{const W=await S(),Z=C;E&&(E.textContent=`This will consume ${Z} credit(s). You have ${W} left.`),W<Z?(alert("Not enough credits. Please top up or reduce the number of posts."),r&&(r.disabled=!0)):r&&(r.disabled=!1)}catch(W){console.error("Error fetching remaining credits:",W),E&&(E.textContent=`Unable to retrieve your credits: ${W.message}`),r&&(r.disabled=!1)}}).catch(h=>{console.error("Error retrieving post count:",h),c&&(c.innerText="Error retrieving post count. Please try again later.")})}),e==null||e.addEventListener("click",()=>{g(s),I(n),c&&(c.innerText=""),E&&(E.textContent=""),i(k,"current"),i(f,"todo")}),m==null||m.addEventListener("submit",async t=>{var w;if(t.preventDefault(),!window.nuclenAdminVars||!window.nuclenAdminVars.ajax_url){alert("Error: WP Ajax config not found. Please check the plugin settings.");return}i(f,"done"),i(P,"current"),I(a),l&&(l.innerText="Processing posts... Do NOT leave this page until the process is complete."),g(s),r&&(r.disabled=!0);try{const d=Object.fromEntries(new FormData(m).entries()),_=await ne(d),x=((w=_.data)==null?void 0:w.generation_id)||_.generation_id||"gen_"+Math.random().toString(36).substring(2);ee({intervalMs:5e3,generationId:x,onProgress:(v,B)=>{const T=v===void 0?0:v,N=B===void 0?"":B;l&&(l.innerText=`Processed ${T} of ${N} posts so far...`)},onComplete:async({failCount:v,finalReport:B,results:T,workflow:N})=>{if(i(P,"done"),i(b,"current"),T&&typeof T=="object")try{const C=await fetch(A,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":L},credentials:"include",body:JSON.stringify({workflow:N,results:T})}),q=await C.json();C.ok&&!q.code?console.log("Bulk content stored in WP meta successfully:",q):console.error("Error storing bulk content in WP meta:",q)}catch(h){console.error("Error storing bulk content in WP meta:",h)}l&&(v&&B?(l.innerText=`Some posts failed. ${B.message||""}`,i(b,"failed")):(l.innerText="All posts processed successfully! Your content has been saved.",i(b,"done"))),r&&(r.disabled=!1),I(o)},onError:v=>{i(P,"failed"),v.includes("Invalid API key")?alert("Your API key is invalid. Please go to the Setup page and enter a new one."):v.includes("Invalid WP App Password")?alert("Your WP App Password is invalid. Please re-generate it on the Setup page."):v.includes("Not enough credits")?alert("Not enough credits. Please top up your account or reduce the number of posts."):alert(`Error: ${v}`),l&&(l.innerText=`Error: ${v}`),r&&(r.disabled=!1),I(o)}})}catch(d){i(P,"failed"),d.message.includes("Invalid API key")?alert("Your API key is invalid. Please go to the Setup page and enter a new one."):d.message.includes("Invalid WP App Password")?alert("Your WP App Password is invalid. Please go to the Setup page and re-generate it."):d.message.includes("Not enough credits")?alert("Not enough credits. Please top up or reduce posts."):alert(`Error starting generation: ${d.message}`),r&&(r.disabled=!1),I(o)}});function y(){const t=document.getElementById("nuclen_generate_workflow"),w=document.getElementById("nuclen-summary-settings"),d=document.getElementById("nuclen-summary-paragraph-options"),_=document.getElementById("nuclen-summary-bullet-options"),x=document.getElementById("nuclen_summary_format");!t||!w||!d||!_||!x||(t.value==="summary"?(w.classList.remove("nuclen-hidden"),x.value==="paragraph"?(d.classList.remove("nuclen-hidden"),_.classList.add("nuclen-hidden")):(d.classList.add("nuclen-hidden"),_.classList.remove("nuclen-hidden"))):(w.classList.add("nuclen-hidden"),d.classList.add("nuclen-hidden"),_.classList.add("nuclen-hidden")))}y();const j=document.getElementById("nuclen_generate_workflow"),D=document.getElementById("nuclen_summary_format");j==null||j.addEventListener("change",y),D==null||D.addEventListener("change",y),o==null||o.addEventListener("click",()=>{g(a),g(o),g(s),c&&(c.innerText=""),E&&(E.textContent=""),I(n),i(k,"current"),i(f,"todo"),i(P,"todo"),i(b,"todo")})})();document.addEventListener("DOMContentLoaded",()=>{const u=document.querySelectorAll(".nav-tab"),n=document.querySelectorAll(".nuclen-tab-content");u.forEach(o=>{o.addEventListener("click",p=>{p.preventDefault();const e=o.getAttribute("href");if(!e)return;u.forEach(r=>r.classList.remove("nav-tab-active")),o.classList.add("nav-tab-active"),n.forEach(r=>{r.style.display="none"});const m=document.querySelector(e);m&&(m.style.display="block")})}),typeof wp<"u"&&typeof wp.wpColorPicker=="function"&&document.querySelectorAll(".wp-color-picker-field").forEach(o=>{wp.wpColorPicker.call(o)});const s=document.getElementById("nuclen-custom-theme-section"),a=document.querySelectorAll("input[name='nuclen_theme']");function l(){const o=document.querySelector("input[name='nuclen_theme']:checked");if(!o||!s)return;o.value==="custom"?s.classList.remove("nuclen-hidden"):s.classList.add("nuclen-hidden")}a.forEach(o=>{o.addEventListener("change",l)}),l()});(function(u){u(document).ready(()=>{const n=window.nePointerData;if(!n||!n.pointers||n.pointers.length===0)return;let s=0;const a=n.pointers,l=n.ajaxurl,o=n.nonce;function p(){if(s>=a.length)return;const e=a[s],m=u(e.target);if(!m.length){s++,p();return}m.pointer({content:`<h3>${e.title}</h3><p>${e.content}</p>`,position:e.position,close:()=>{u.post(l,{action:"nuclen_dismiss_pointer",pointer:e.id,nonce:o}),s++,p()}}).pointer("open")}p()})})(window.jQuery);
