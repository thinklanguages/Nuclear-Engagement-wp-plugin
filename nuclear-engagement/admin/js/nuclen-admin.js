import{w as N,e as g}from"../../logger-CjYDh3vN.js";const I={RETRY_COUNT:3,INITIAL_DELAY_MS:500,POLLING_INTERVAL_MS:5e3};async function B(e,t,n=I.RETRY_COUNT,o=I.INITIAL_DELAY_MS){let a=0,r=o,i;for(;a<=n;){try{const c=await fetch(e,t),{status:s,ok:u}=c,d=await c.text().catch(()=>"");let p=null;if(d)try{p=JSON.parse(d)}catch{}return u?{ok:!0,status:s,data:p}:{ok:!1,status:s,data:p,error:d}}catch(c){if(i=c,a===n)break;N(`Retrying request to ${e} with method ${t.method||"GET"} (${n-a} attempts left). Error: ${i.message}`,i),await new Promise(s=>setTimeout(s,r)),r*=2}a+=1}throw g(`Max retries reached for ${e} with method ${t.method||"GET"}:`,i),i}async function O(e){if(!window.nuclenAjax||!window.nuclenAjax.ajax_url||!window.nuclenAjax.fetch_action)throw new Error("Missing nuclenAjax configuration (ajax_url or fetch_action).");const t=new FormData;t.append("action",window.nuclenAjax.fetch_action),window.nuclenAjax.nonce&&t.append("security",window.nuclenAjax.nonce),e&&t.append("generation_id",e);const n=await B(window.nuclenAjax.ajax_url,{method:"POST",body:t,credentials:"same-origin"});if(!n.ok)throw new Error(n.error||`HTTP ${n.status}`);return n.data}async function k(e){var r;if(!window.nuclenAdminVars||!window.nuclenAdminVars.ajax_url)throw new Error("Missing WP Ajax config (nuclenAdminVars.ajax_url).");const t=new FormData;if(t.append("action","nuclen_trigger_generation"),t.append("payload",JSON.stringify(e)),!((r=window.nuclenAjax)!=null&&r.nonce))throw new Error("Missing security nonce.");t.append("security",window.nuclenAjax.nonce);const n=await B(window.nuclenAdminVars.ajax_url,{method:"POST",body:t,credentials:"same-origin"});if(!n.ok)throw new Error(n.error||`HTTP ${n.status}`);const o=n.data;if(!o||typeof o!="object")throw new Error("Invalid response format: expected object");const a=o;if(typeof a.success!="boolean")throw new Error("Invalid response format: missing or invalid success field");if(!a.success){let i="Generation start failed (unknown error).";throw typeof a.message=="string"&&a.message?i=a.message:a.data&&typeof a.data=="object"&&typeof a.data.message=="string"&&(i=a.data.message),new Error(i)}return a}function P({intervalMs:e=I.POLLING_INTERVAL_MS,generationId:t,onProgress:n=()=>{},onComplete:o=()=>{},onError:a=()=>{},maxAttempts:r=120,timeoutMs:i=6e5}){let c=0;const s=Date.now(),u=setInterval(async()=>{c++;const d=Date.now()-s;if(c>r){clearInterval(u),a(`Polling timeout: Exceeded maximum attempts (${r})`);return}if(d>i){clearInterval(u),a(`Polling timeout: Exceeded maximum time (${i}ms)`);return}try{const p=await O(t);if(!p.success){const j=p.message||"Polling error";throw new Error(j)}const{processed:m,total:y,successCount:E=m,failCount:b,finalReport:A,results:T,workflow:L}=p.data;n(m,y),m>=y&&(clearInterval(u),o({processed:m,total:y,successCount:E,failCount:b,finalReport:A,results:T,workflow:L}))}catch(p){clearInterval(u);const m=p instanceof Error?p.message:"Unknown error";a(`Polling failed after ${c} attempts: ${m}`)}},e);return()=>{clearInterval(u)}}function f(e){const t=document.createElement("div");t.className="nuclen-error-toast",t.textContent=e,document.body.appendChild(t),setTimeout(()=>t.remove(),5e3),g(e)}var x;const F=((x=window.nuclenAdminVars)==null?void 0:x.rest_receive_content)||"/wp-json/nuclear-engagement/v1/receive-content";var S;const $=((S=window.nuclenAdminVars)==null?void 0:S.rest_nonce)||"";function h(e){const t=e.replace(/<[^>]+>/g,"");t.includes("Invalid API key")?f("Your API key is invalid. Please go to the Setup page and enter a new one."):t.includes("Invalid WP App Password")?f("Your WP App Password is invalid. Please re-generate it on the Setup page."):t.includes("Not enough credits")?f("Not enough credits. Please top up your account or reduce the number of posts."):f(`Error: ${t}`)}async function C(e,t){const n={workflow:e,results:t};let o;try{o=await fetch(F,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":$},credentials:"include",body:JSON.stringify(n)})}catch(r){return g("Fetch failed in nuclenStoreGenerationResults:",r),f("Network error"),{ok:!1,data:{message:"Network error"}}}let a=null;if(o.ok)try{a=await o.json()}catch{return{ok:!1,data:{message:"Invalid JSON"}}}return{ok:o.ok,data:a}}function R(e,t){const{date:n,questions:o}=e,a=t||n,r=document.querySelector('input[name="nuclen_quiz_data[date]"]');r&&(r.readOnly=!1,r.value=a||"",r.readOnly=!0),Array.isArray(o)&&o.forEach((i,c)=>{const s=`input[name="nuclen_quiz_data[questions][${c}][question]"]`,u=document.querySelector(s);u&&(u.value=i.question||""),Array.isArray(i.answers)&&i.answers.forEach((m,y)=>{const E=`input[name="nuclen_quiz_data[questions][${c}][answers][${y}]"]`,b=document.querySelector(E);b&&(b.value=m)});const d=`textarea[name="nuclen_quiz_data[questions][${c}][explanation]"]`,p=document.querySelector(d);p&&(p.value=i.explanation||"")})}function q(e,t){var i;const{date:n,summary:o}=e,a=t||n,r=document.querySelector('input[name="nuclen_summary_data[date]"]');if(r&&(r.readOnly=!1,r.value=a||"",r.readOnly=!0),typeof window.tinymce<"u"){const c=window.tinymce;let s;if(typeof c.get=="function"&&(s=c.get("nuclen_summary_data_summary")),s&&typeof s.setContent=="function")s.setContent(o||""),(i=s.save)==null||i.call(s);else{const u=document.querySelector('textarea[name="nuclen_summary_data[summary]"]');u&&(u.value=o||"")}}else{const c=document.querySelector('textarea[name="nuclen_summary_data[summary]"]');c&&(c.value=o||"")}}function D(){document.addEventListener("click",async e=>{var r;const t=e.target;if(!(t instanceof HTMLElement)||!t.classList.contains("nuclen-generate-single"))return;const n=t,o=n.dataset.postId,a=n.dataset.workflow;if(!o||!a){f("Missing data attributes: postId or workflow not found.");return}n.disabled=!0,n.textContent="Generating...";try{const i=await k({nuclen_selected_post_ids:JSON.stringify([o]),nuclen_selected_generate_workflow:a});if("ok"in i&&!i.ok){h(i.error||"Generation failed"),n.textContent="Generate",n.disabled=!1;return}const c=((r=i.data)==null?void 0:r.generation_id)||i.generation_id||"gen_"+Math.random().toString(36).substring(2);P({intervalMs:5e3,generationId:c,onProgress(){n.textContent="Generating..."},async onComplete({results:s,workflow:u}){if(s&&typeof s=="object")try{const{ok:d,data:p}=await C(u,s),m=p;if(d&&!("code"in m)){const y=s[o],E=m.finalDate&&typeof m.finalDate=="string"?m.finalDate:void 0;y&&(u==="quiz"?R(y,E):u==="summary"&&q(y,E)),n.textContent="Stored!"}else g("Error storing single-generation results in WP:",m),n.textContent="Generation failed!"}catch(d){g("Fetch error calling /receive-content endpoint:",d),n.textContent="Generation failed!"}else n.textContent="Done (no data)!";n.disabled=!1},onError(s){h(s),n.textContent="Generate",n.disabled=!1}})}catch(i){const c=i instanceof Error?i.message:"Unknown error";h(c),n.textContent="Generate",n.disabled=!1}})}D();function G(){return{step1:document.getElementById("nuclen-step-1"),step2:document.getElementById("nuclen-step-2"),updatesSection:document.getElementById("nuclen-updates-section"),updatesContent:document.getElementById("nuclen-updates-content"),restartBtn:document.getElementById("nuclen-restart-btn"),getPostsBtn:document.getElementById("nuclen-get-posts-btn"),goBackBtn:document.getElementById("nuclen-go-back-btn"),generateForm:document.getElementById("nuclen-generate-form"),submitBtn:document.getElementById("nuclen-submit-btn"),postsCountEl:document.getElementById("nuclen-posts-count"),stepBar1:document.getElementById("nuclen-step-bar-1"),stepBar2:document.getElementById("nuclen-step-bar-2"),stepBar3:document.getElementById("nuclen-step-bar-3"),stepBar4:document.getElementById("nuclen-step-bar-4"),creditsInfoEl:document.getElementById("nuclen-credits-info")}}function w(e){e&&e.classList.remove("nuclen-hidden")}function _(e){e&&e.classList.add("nuclen-hidden")}function l(e,t){e&&(e.classList.remove("ne-step-bar__step--todo","ne-step-bar__step--current","ne-step-bar__step--done","ne-step-bar__step--failed"),e.classList.add(`ne-step-bar__step--${t}`))}async function M(){var o;if(!window.nuclenAjax||!window.nuclenAjax.ajax_url)throw new Error("Missing nuclenAjax configuration (ajax_url).");if(!window.nuclenAjax.fetch_action)throw new Error("Missing fetch_action in nuclenAjax configuration.");const e=new FormData;e.append("action",window.nuclenAjax.fetch_action),window.nuclenAjax.nonce&&e.append("security",window.nuclenAjax.nonce);const t=await B(window.nuclenAjax.ajax_url,{method:"POST",body:e,credentials:"same-origin"});if(!t.ok)throw new Error(t.error||`HTTP ${t.status}`);const n=t.data;if(!n.success)throw new Error(n.message||((o=n.data)==null?void 0:o.message)||"Failed to fetch credits from SaaS");if(typeof n.data.remaining_credits=="number")return n.data.remaining_credits;throw new Error("No 'remaining_credits' in response")}function v(){const e=document.getElementById("nuclen_generate_workflow"),t=document.getElementById("nuclen-summary-settings"),n=document.getElementById("nuclen-summary-paragraph-options"),o=document.getElementById("nuclen-summary-bullet-options"),a=document.getElementById("nuclen_summary_format");!e||!t||!n||!o||!a||(e.value==="summary"?(t.classList.remove("nuclen-hidden"),a.value==="paragraph"?(n.classList.remove("nuclen-hidden"),o.classList.add("nuclen-hidden")):(n.classList.add("nuclen-hidden"),o.classList.remove("nuclen-hidden"))):(t.classList.add("nuclen-hidden"),n.classList.add("nuclen-hidden"),o.classList.add("nuclen-hidden")))}function V(){const e=document.getElementById("nuclen_post_status"),t=document.getElementById("nuclen_category"),n=document.getElementById("nuclen_author"),o=document.getElementById("nuclen_post_type"),a=document.getElementById("nuclen_generate_workflow"),r=document.getElementById("nuclen_allow_regenerate_data"),i=document.getElementById("nuclen_regenerate_protected_data"),c=document.getElementById("nuclen_summary_format"),s=document.getElementById("nuclen_summary_length"),u=document.getElementById("nuclen_summary_number_of_items");return{postStatus:e?e.value:"",category:t?t.value:"",author:n?n.value:"",postType:o?o.value:"",workflow:a?a.value:"",allowRegenerate:!!r&&r.checked,regenerateProtected:!!i&&i.checked,summaryFormat:c?c.value:"",summaryLength:s?s.value:"",summaryNumberOfItems:u?u.value:""}}function U(e,t){e.append("nuclen_post_status",t.postStatus),e.append("nuclen_category",t.category),e.append("nuclen_author",t.author),e.append("nuclen_post_type",t.postType),e.append("nuclen_generate_workflow",t.workflow),e.append("nuclen_allow_regenerate_data",t.allowRegenerate?"1":"0"),e.append("nuclen_regenerate_protected_data",t.regenerateProtected?"1":"0"),e.append("nuclen_summary_format",t.summaryFormat),e.append("nuclen_summary_length",t.summaryLength),e.append("nuclen_summary_number_of_items",t.summaryNumberOfItems)}function W(e){const t=document.getElementById("nuclen_selected_generate_workflow"),n=document.getElementById("nuclen_selected_summary_format"),o=document.getElementById("nuclen_selected_summary_length"),a=document.getElementById("nuclen_selected_summary_number_of_items"),r=document.getElementById("nuclen_selected_post_status"),i=document.getElementById("nuclen_selected_post_type");t&&(t.value=e.workflow),n&&(n.value=e.summaryFormat),o&&(o.value=e.summaryLength),a&&(a.value=e.summaryNumberOfItems),r&&(r.value=e.postStatus),i&&(i.value=e.postType)}async function Y(e,t){var a;const n=new FormData;n.append("action","nuclen_get_posts_count"),(a=window.nuclenAjax)!=null&&a.nonce&&n.append("security",window.nuclenAjax.nonce),U(n,t);const o=await B(e,{method:"POST",body:n,credentials:"same-origin"});return o.ok?o.data:null}async function z(e,t){try{const n=await M(),o=t;e.creditsInfoEl&&(e.creditsInfoEl.textContent=`This will consume ${o} credit(s). You have ${n} left.`),n<o?(f("Not enough credits. Please top up or reduce the number of posts."),e.submitBtn&&(e.submitBtn.disabled=!0)):e.submitBtn&&(w(e.submitBtn),e.submitBtn.disabled=!1)}catch(n){g("Error fetching remaining credits:",n);const o=n instanceof Error?n.message:"Unknown error";e.creditsInfoEl&&(e.creditsInfoEl.textContent=`Unable to retrieve your credits: ${o}`),e.submitBtn&&(e.submitBtn.disabled=!1)}}function J(e){var t;(t=e.getPostsBtn)==null||t.addEventListener("click",async()=>{var c;if(!window.nuclenAjax||!window.nuclenAjax.ajax_url){f("Error: Ajax is not configured properly. Please check the plugin settings.");return}e.postsCountEl&&(e.postsCountEl.innerText="Loading posts...");const n=V(),o=await Y(window.nuclenAjax.ajax_url||"",n);if(!o){g("Error retrieving post count"),e.postsCountEl&&(e.postsCountEl.innerText="Error retrieving post count.");return}if(!o.success){e.postsCountEl&&(e.postsCountEl.innerText="Error retrieving post count.");const s=o.message||((c=o.data)==null?void 0:c.message);s&&(s.includes("Invalid API key")?f("Your Gold Code (API key) is invalid. Please create a new one on the NE app and enter it on the plugin Setup page."):s.includes("Invalid WP App Password")?f("Your WP App Password is invalid. Please go to the plugin Setup page and re-generate it."):f(s));return}const a=o.data.count,r=o.data.post_ids,i=document.getElementById("nuclen_selected_post_ids");if(i&&(i.value=JSON.stringify(r)),W(n),_(e.step1),w(e.step2),l(e.stepBar1,"done"),l(e.stepBar2,"current"),a===0){e.postsCountEl&&(e.postsCountEl.innerText="No posts found with these filters."),e.submitBtn&&_(e.submitBtn);return}e.postsCountEl&&(e.postsCountEl.innerText=`Number of posts to process: ${a}`),await z(e,a)})}async function H(e,t){if(!(!t||typeof t!="object"))try{const{ok:n,data:o}=await C(e,t),a=o;(!n||"code"in a)&&g("Error storing bulk content in WP meta:",a)}catch(n){g("Error storing bulk content in WP meta:",n)}}function Q(e,t,n){e.updatesContent&&(t&&n?(e.updatesContent.innerText=`Some posts failed. ${n.message||""}`,l(e.stepBar4,"failed")):(e.updatesContent.innerText="All posts processed successfully! Your content has been saved.",l(e.stepBar4,"done"))),e.submitBtn&&(e.submitBtn.disabled=!1),w(e.restartBtn)}function X(e){var t;(t=e.generateForm)==null||t.addEventListener("submit",async n=>{var o;if(n.preventDefault(),!window.nuclenAdminVars||!window.nuclenAdminVars.ajax_url){f("Error: WP Ajax config not found. Please check the plugin settings.");return}l(e.stepBar2,"done"),l(e.stepBar3,"current"),w(e.updatesSection),e.updatesContent&&(e.updatesContent.innerText="Processing posts... Do NOT leave this page until the process is complete."),_(e.step2),e.submitBtn&&(e.submitBtn.disabled=!0);try{const a=Object.fromEntries(new FormData(e.generateForm).entries()),r=await k(a),i=((o=r.data)==null?void 0:o.generation_id)||r.generation_id||"gen_"+Math.random().toString(36).substring(2);P({intervalMs:5e3,generationId:i,onProgress:(c,s)=>{const u=c===void 0?0:c,d=s===void 0?"":s;e.updatesContent&&(e.updatesContent.innerText=`Processed ${u} of ${d} posts so far...`)},onComplete:async({failCount:c,finalReport:s,results:u,workflow:d})=>{l(e.stepBar3,"done"),l(e.stepBar4,"current"),await H(d,u),Q(e,c,s)},onError:c=>{l(e.stepBar3,"failed"),h(c),e.updatesContent&&(e.updatesContent.innerText=`Error: ${c}`),e.submitBtn&&(e.submitBtn.disabled=!1),w(e.restartBtn)}})}catch(a){l(e.stepBar3,"failed");const r=a instanceof Error?a.message:"Unknown error";h(r),e.submitBtn&&(e.submitBtn.disabled=!1),w(e.restartBtn)}})}function K(e){var t;(t=e.goBackBtn)==null||t.addEventListener("click",()=>{_(e.step2),w(e.step1),e.postsCountEl&&(e.postsCountEl.innerText=""),e.creditsInfoEl&&(e.creditsInfoEl.textContent=""),l(e.stepBar1,"current"),l(e.stepBar2,"todo")})}function Z(e){var t;(t=e.restartBtn)==null||t.addEventListener("click",()=>{_(e.updatesSection),_(e.restartBtn),_(e.step2),e.postsCountEl&&(e.postsCountEl.innerText=""),e.creditsInfoEl&&(e.creditsInfoEl.textContent=""),w(e.step1),l(e.stepBar1,"current"),l(e.stepBar2,"todo"),l(e.stepBar3,"todo"),l(e.stepBar4,"todo")})}function ee(){v();const e=document.getElementById("nuclen_generate_workflow"),t=document.getElementById("nuclen_summary_format");e==null||e.addEventListener("change",v),t==null||t.addEventListener("change",v)}function te(){const e=G();e.step1&&e.step1.classList.remove("nuclen-hidden"),e.step2&&e.step2.classList.add("nuclen-hidden"),e.updatesSection&&e.updatesSection.classList.add("nuclen-hidden"),e.restartBtn&&e.restartBtn.classList.add("nuclen-hidden"),e.stepBar1&&e.stepBar1.classList.add("ne-step-bar__step--current"),e.stepBar2&&e.stepBar2.classList.add("ne-step-bar__step--todo"),e.stepBar3&&e.stepBar3.classList.add("ne-step-bar__step--todo"),e.stepBar4&&e.stepBar4.classList.add("ne-step-bar__step--todo"),J(e),X(e),K(e),Z(e),ee()}te();document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelectorAll(".nav-tab"),t=document.querySelectorAll(".nuclen-tab-content");e.forEach(r=>{r.addEventListener("click",i=>{i.preventDefault();const c=r.getAttribute("href");if(!c)return;e.forEach(u=>u.classList.remove("nav-tab-active")),r.classList.add("nav-tab-active"),t.forEach(u=>{u.style.display="none"});const s=document.querySelector(c);s&&(s.style.display="block")})});const n=document.getElementById("nuclen-custom-theme-section"),o=document.querySelectorAll("input[name='nuclen_theme']");function a(){const r=document.querySelector("input[name='nuclen_theme']:checked");if(!r||!n)return;r.value==="custom"?n.classList.remove("nuclen-hidden"):n.classList.add("nuclen-hidden")}o.forEach(r=>{r.addEventListener("change",a)}),a()});(function(e){e(document).ready(()=>{const t=window.nePointerData;if(!t||!t.pointers||t.pointers.length===0)return;let n=0;const o=t.pointers,a=t.ajaxurl,r=t.nonce;async function i(s){const u=new URLSearchParams;u.append("action","nuclen_dismiss_pointer"),u.append("pointer",s),r&&u.append("nonce",r);try{const d=await B(a,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:u.toString()});d.ok||(g("Failed to dismiss pointer:",d.error),f("Failed to dismiss pointer."))}catch(d){g("Error dismissing pointer:",d),f("Network error while dismissing pointer.")}}function c(){if(n>=o.length)return;const s=o[n],u=e(s.target);if(!u.length){n++,c();return}u.pointer({content:`<h3>${s.title}</h3><p>${s.content}</p>`,position:s.position,close:async()=>{await i(s.id),n++,c()}}).pointer("open")}c()})})(jQuery);(function(){if(!document.body.classList.contains("block-editor-page"))return;const e=window.wp;if(!e||!e.blocks||!e.element||!e.i18n)return;const{registerBlockType:t}=e.blocks,{createElement:n}=e.element,{__:o}=e.i18n;t("nuclear-engagement/quiz",{apiVersion:2,title:o("Quiz","nuclear-engagement"),icon:"editor-help",category:"widgets",edit:()=>n("p",null,o("Quiz will render on the front-end.","nuclear-engagement")),save:()=>null}),t("nuclear-engagement/summary",{apiVersion:2,title:o("Summary","nuclear-engagement"),icon:"excerpt-view",category:"widgets",edit:()=>n("p",null,o("Summary will render on the front-end.","nuclear-engagement")),save:()=>null}),t("nuclear-engagement/toc",{apiVersion:2,title:o("TOC","nuclear-engagement"),icon:"list-view",category:"widgets",edit:()=>n("p",null,o("TOC will render on the front-end.","nuclear-engagement")),save:()=>null})})();
//# sourceMappingURL=nuclen-admin.js.map
