{"version":3,"file":"nuclen-tasks.js","sources":["../../../src/admin/ts/tasks.ts"],"sourcesContent":["/**\n * Nuclear Engagement Tasks Page JavaScript\n */\n\nimport { error, log } from '../../shared/logger';\n\ndeclare const ajaxurl: string;\ndeclare const nuclen_tasks: {\n    nonce: string;\n    i18n: {\n        processing: string;\n        cancelling: string;\n        error: string;\n        success: string;\n    };\n};\n\ninterface TaskData {\n    id: string;\n    workflow_type: string;\n    status: string;\n    progress: number;\n    details: string;\n    created_at: string;\n    scheduled_at?: string;\n    failed?: number;\n}\n\ninterface PollingConfig {\n    initialInterval: number;\n    intervals: Array<{ after: number; interval: number }>;\n    maxInterval: number;\n}\n\nclass TasksManager {\n    private isProcessing = false;\n    private isRefreshing = false;\n    private currentPage = 1;\n    \n    // Polling configuration\n    private pollingTimer: number | null = null;\n    private pollingStartTime: number = 0;\n    private isPageVisible = true;\n    private lastTasksData: Map<string, TaskData> = new Map();\n    private pollingConfig: PollingConfig = {\n        initialInterval: 15000, // 15 seconds\n        intervals: [\n            { after: 60000, interval: 30000 },    // After 1 minute, poll every 30s\n            { after: 300000, interval: 60000 },   // After 5 minutes, poll every 60s\n            { after: 600000, interval: 120000 },  // After 10 minutes, poll every 2 minutes\n        ],\n        maxInterval: 300000, // Max 5 minutes\n    };\n    \n    // Track active tasks for smart polling\n    private activeTasks = new Set<string>();\n    \n    // Auto-refresh UI elements\n    private pollingIndicator: HTMLElement | null = null;\n    private autoRefreshBanner: HTMLElement | null = null;\n    private nextPollTime: number = 0;\n    private countdownInterval: number | null = null;\n    \n    // Bound event handlers for cleanup\n    private handleVisibilityChange = this.onVisibilityChange.bind(this);\n    private handleWindowBlur = this.onWindowBlur.bind(this);\n    private handleWindowFocus = this.onWindowFocus.bind(this);\n\n    constructor() {\n        this.init();\n        \n        // Cleanup on page unload\n        window.addEventListener('beforeunload', () => {\n            this.cleanup();\n        });\n    }\n\n    private init(): void {\n        \n        // Check for recent completions on page load\n        this.checkRecentCompletions();\n        \n        // Attach event listeners to action buttons\n        this.attachActionHandlers();\n        \n        // Convert the refresh link to a button with AJAX functionality\n        this.setupRefreshButton();\n        \n        // Setup page visibility handling\n        this.setupPageVisibilityHandling();\n        \n        // Initialize task tracking\n        this.initializeTaskTracking();\n        \n        // Create polling indicator\n        this.createPollingIndicator();\n        \n        // Start smart polling\n        this.startSmartPolling();\n    }\n\n    private setupPageVisibilityHandling(): void {\n        // Use Page Visibility API to pause polling when tab is hidden\n        document.addEventListener('visibilitychange', this.handleVisibilityChange);\n        \n        // Also handle window focus/blur as backup\n        window.addEventListener('blur', this.handleWindowBlur);\n        window.addEventListener('focus', this.handleWindowFocus);\n    }\n    \n    private onVisibilityChange(): void {\n        this.isPageVisible = !document.hidden;\n        log(`Page visibility changed: ${this.isPageVisible ? 'visible' : 'hidden'}`);\n        \n        if (this.isPageVisible) {\n            // Resume polling when page becomes visible\n            if (this.activeTasks.size > 0) {\n                this.startSmartPolling();\n            }\n        } else {\n            // Pause polling when page is hidden\n            this.stopPolling();\n        }\n    }\n    \n    private onWindowBlur(): void {\n        this.isPageVisible = false;\n        this.stopPolling();\n    }\n    \n    private onWindowFocus(): void {\n        this.isPageVisible = true;\n        if (this.activeTasks.size > 0) {\n            // Immediately refresh when window regains focus\n            this.refreshTasksData().catch(err => {\n                error('Failed to refresh on focus:', err);\n            });\n            this.startSmartPolling();\n        }\n    }\n    \n    private initializeTaskTracking(): void {\n        // Track all current tasks and their states\n        const rows = document.querySelectorAll('.nuclen-tasks-table tbody tr');\n        rows.forEach(row => {\n            const taskId = row.getAttribute('data-task-id');\n            const statusCell = row.querySelector('.column-status');\n            if (taskId && statusCell) {\n                const statusText = statusCell.textContent?.toLowerCase() || '';\n                \n                // Track as active if processing, pending, or scheduled\n                if (statusText.includes('processing') || statusText.includes('pending') || statusText.includes('scheduled')) {\n                    this.activeTasks.add(taskId);\n                }\n                \n                // Store initial task data\n                this.lastTasksData.set(taskId, this.extractTaskDataFromRow(row as HTMLElement));\n            }\n        });\n        \n        log(`Initialized task tracking: ${this.activeTasks.size} active tasks`);\n    }\n    \n    private extractTaskDataFromRow(row: HTMLElement): TaskData {\n        const taskId = row.getAttribute('data-task-id') || '';\n        const statusCell = row.querySelector('.column-status');\n        const progressCell = row.querySelector('.column-progress');\n        const detailsCell = row.querySelector('td:nth-child(7)'); // Details column is now 7th\n        \n        // Extract progress number from progress bar\n        let progress = 0;\n        const progressText = progressCell?.querySelector('.nuclen-progress-text')?.textContent;\n        if (progressText) {\n            const match = progressText.match(/(\\d+)%/);\n            if (match) {\n                progress = parseInt(match[1], 10);\n            }\n        }\n        \n        return {\n            id: taskId,\n            workflow_type: row.querySelector('td:nth-child(4)')?.textContent || '', // Type column is now 4th\n            status: this.extractStatusFromBadge(statusCell?.innerHTML || ''),\n            progress: progress,\n            details: detailsCell?.innerHTML || '',\n            created_at: row.querySelector('td:nth-child(1)')?.textContent || '',\n            scheduled_at: row.querySelector('td:nth-child(2)')?.textContent || '',\n            failed: this.extractFailedCount(detailsCell?.innerHTML || ''),\n        };\n    }\n    \n    private extractStatusFromBadge(badgeHtml: string): string {\n        // Extract status from badge class\n        const match = badgeHtml.match(/nuclen-badge-(\\w+)/);\n        if (match) {\n            const badgeClass = match[1];\n            switch (badgeClass) {\n                case 'warning':\n                    return badgeHtml.includes('Pending') ? 'pending' : 'completed_with_errors';\n                case 'info':\n                    return 'processing';\n                case 'success':\n                    return 'completed';\n                case 'error':\n                    return 'failed';\n                default:\n                    return 'cancelled';\n            }\n        }\n        return 'unknown';\n    }\n    \n    private extractFailedCount(detailsHtml: string): number {\n        const match = detailsHtml.match(/(\\d+)\\s+failed/);\n        return match ? parseInt(match[1], 10) : 0;\n    }\n    \n    private cleanup(): void {\n        // Stop polling\n        this.stopPolling();\n        \n        // Clear countdown\n        if (this.countdownInterval) {\n            clearInterval(this.countdownInterval);\n            this.countdownInterval = null;\n        }\n        \n        // Remove polling indicator\n        if (this.pollingIndicator) {\n            this.pollingIndicator.remove();\n        }\n        \n        // Remove auto-refresh banner\n        if (this.autoRefreshBanner) {\n            this.autoRefreshBanner.remove();\n        }\n        \n        // Clear stored data to free memory\n        this.lastTasksData.clear();\n        this.activeTasks.clear();\n        \n        // Remove event listeners\n        document.removeEventListener('visibilitychange', this.handleVisibilityChange);\n        window.removeEventListener('blur', this.handleWindowBlur);\n        window.removeEventListener('focus', this.handleWindowFocus);\n    }\n    \n    private startSmartPolling(): void {\n        // Don't start if page is not visible or no active tasks\n        if (!this.isPageVisible || this.activeTasks.size === 0) {\n            this.updatePollingIndicator(false);\n            return;\n        }\n        \n        // Clear any existing timer\n        this.stopPolling();\n        \n        // Record polling start time\n        if (this.pollingStartTime === 0) {\n            this.pollingStartTime = Date.now();\n        }\n        \n        // Calculate appropriate interval based on elapsed time\n        const elapsedTime = Date.now() - this.pollingStartTime;\n        let interval = this.pollingConfig.initialInterval;\n        \n        for (const config of this.pollingConfig.intervals) {\n            if (elapsedTime > config.after) {\n                interval = config.interval;\n            }\n        }\n        \n        // Cap at max interval\n        interval = Math.min(interval, this.pollingConfig.maxInterval);\n        \n        log(`Starting smart polling with interval: ${interval / 1000}s, active tasks: ${this.activeTasks.size}`);\n        \n        // Update UI\n        this.nextPollTime = Date.now() + interval;\n        this.updatePollingIndicator(true, interval);\n        this.startCountdown();\n        \n        // Schedule next poll\n        this.pollingTimer = window.setTimeout(() => {\n            this.pollForUpdates();\n        }, interval);\n    }\n    \n    private stopPolling(): void {\n        if (this.pollingTimer) {\n            clearTimeout(this.pollingTimer);\n            this.pollingTimer = null;\n            log('Polling stopped');\n        }\n        \n        // Stop countdown\n        if (this.countdownInterval) {\n            clearInterval(this.countdownInterval);\n            this.countdownInterval = null;\n        }\n        \n        // Update UI\n        this.updatePollingIndicator(false);\n    }\n    \n    private async pollForUpdates(): Promise<void> {\n        if (!this.isPageVisible || this.isRefreshing) {\n            return;\n        }\n        \n        try {\n            log('Polling for task updates...');\n            \n            const response = await fetch(ajaxurl, {\n                method: 'POST',\n                headers: {\n                    'Content-Type': 'application/x-www-form-urlencoded',\n                },\n                body: new URLSearchParams({\n                    action: 'nuclen_refresh_tasks_data',\n                    nonce: nuclen_tasks.nonce,\n                    page: this.currentPage.toString(),\n                })\n            });\n            \n            if (!response.ok) {\n                throw new Error(`HTTP error! status: ${response.status}`);\n            }\n            \n            const result = await response.json();\n            \n            if (result && result.success && result.data && Array.isArray(result.data.tasks)) {\n                this.updateTasksFromPolling(result.data.tasks);\n                \n                // Only show update indicator if tasks were actually updated\n                if (result.data.tasks.length > 0) {\n                    this.showUpdateIndicator();\n                }\n            }\n        } catch (err) {\n            error('Failed to poll for updates:', err);\n            // Don't stop polling on error, just skip this iteration\n        } finally {\n            // Continue polling if there are still active tasks\n            if (this.activeTasks.size > 0 && this.isPageVisible) {\n                this.startSmartPolling();\n            } else if (this.activeTasks.size === 0) {\n                log('No active tasks remaining, stopping polling');\n                this.pollingStartTime = 0;\n            }\n        }\n    }\n    \n    private updateTasksFromPolling(newTasks: TaskData[]): void {\n        const updatedTasks = new Set<string>();\n        \n        // Limit stored tasks to prevent memory issues\n        const MAX_STORED_TASKS = 100;\n        if (this.lastTasksData.size > MAX_STORED_TASKS) {\n            // Remove old completed/cancelled tasks first\n            const tasksToRemove: string[] = [];\n            this.lastTasksData.forEach((task, id) => {\n                if (!this.activeTasks.has(id) && \n                    (task.status === 'completed' || task.status === 'cancelled' || task.status === 'failed')) {\n                    tasksToRemove.push(id);\n                }\n            });\n            \n            // Remove enough tasks to get under the limit\n            const removeCount = Math.min(tasksToRemove.length, this.lastTasksData.size - MAX_STORED_TASKS + 10); // +10 for buffer\n            tasksToRemove.slice(0, removeCount).forEach(id => this.lastTasksData.delete(id));\n        }\n        \n        newTasks.forEach(newTask => {\n            const oldTask = this.lastTasksData.get(newTask.id);\n            \n            // Check if task has changed\n            if (!oldTask || this.hasTaskChanged(oldTask, newTask)) {\n                // Update the DOM for this specific task\n                this.updateSingleTaskRow(newTask);\n                updatedTasks.add(newTask.id);\n                \n                // Update our stored data\n                this.lastTasksData.set(newTask.id, newTask);\n            }\n            \n            // Update active tasks tracking\n            if (newTask.status === 'processing' || newTask.status === 'pending' || newTask.status === 'scheduled') {\n                this.activeTasks.add(newTask.id);\n            } else {\n                this.activeTasks.delete(newTask.id);\n            }\n        });\n        \n        if (updatedTasks.size > 0) {\n            log(`Updated ${updatedTasks.size} tasks: ${Array.from(updatedTasks).join(', ')}`);\n        }\n    }\n    \n    private hasTaskChanged(oldTask: TaskData, newTask: TaskData): boolean {\n        return (\n            oldTask.status !== newTask.status ||\n            oldTask.progress !== newTask.progress ||\n            oldTask.failed !== newTask.failed ||\n            oldTask.details !== newTask.details\n        );\n    }\n    \n    private updateSingleTaskRow(task: TaskData): void {\n        const row = document.querySelector(`tr[data-task-id=\"${task.id}\"]`);\n        if (!row) return;\n        \n        // Update only the changed cells\n        this.updateTasksTable([task]);\n    }\n    \n    private showUpdateIndicator(): void {\n        // Find or create update indicator\n        let indicator = document.querySelector('.nuclen-update-indicator') as HTMLElement;\n        if (!indicator) {\n            indicator = document.createElement('div');\n            indicator.className = 'nuclen-update-indicator';\n            indicator.innerHTML = '<span class=\"dashicons dashicons-update spin\"></span> Updated';\n            \n            const pageTitle = document.querySelector('.wrap h1');\n            if (pageTitle) {\n                pageTitle.appendChild(indicator);\n            } else {\n                // Fallback: add to body if page title not found\n                document.body.appendChild(indicator);\n            }\n        }\n        \n        // Show indicator\n        indicator.classList.add('visible');\n        \n        // Hide after 2 seconds\n        setTimeout(() => {\n            if (indicator && indicator.parentNode) {\n                indicator.classList.remove('visible');\n            }\n        }, 2000);\n    }\n\n    private attachActionHandlers(): void {\n        // Handle run now buttons\n        document.querySelectorAll('.nuclen-run-now').forEach(button => {\n            button.addEventListener('click', (e) => this.handleRunTask(e));\n        });\n\n        // Handle cancel buttons\n        document.querySelectorAll('.nuclen-cancel').forEach(button => {\n            button.addEventListener('click', (e) => this.handleCancelTask(e));\n        });\n\n        // Handle retry buttons\n        document.querySelectorAll('.nuclen-retry').forEach(button => {\n            button.addEventListener('click', (e) => this.handleRetryTask(e));\n        });\n\n    }\n\n    private setupRefreshButton(): void {\n        // Find the refresh link\n        const refreshLink = document.querySelector('a[href*=\"refresh=1\"]');\n        if (!refreshLink) return;\n\n        // Get current page from URL if available\n        const urlParams = new URLSearchParams(window.location.search);\n        this.currentPage = parseInt(urlParams.get('paged') || '1', 10);\n\n        // Convert to button\n        const refreshButton = document.createElement('button');\n        refreshButton.className = 'button button-small nuclen-refresh-button';\n        refreshButton.innerHTML = '<span class=\"dashicons dashicons-update\"></span> Refresh';\n        refreshButton.title = 'Refresh task data';\n        \n        // Replace link with button\n        refreshLink.parentNode?.replaceChild(refreshButton, refreshLink);\n        \n        // Add click handler\n        refreshButton.addEventListener('click', (e) => {\n            e.preventDefault();\n            this.refreshTasksData();\n        });\n    }\n\n    private async refreshTasksData(): Promise<void> {\n        if (this.isRefreshing) return;\n        \n        this.isRefreshing = true;\n        \n        try {\n            // Add visual feedback\n            const refreshButton = document.querySelector('.nuclen-refresh-button');\n            if (refreshButton) {\n                refreshButton.classList.add('is-busy');\n                refreshButton.setAttribute('disabled', 'disabled');\n            }\n            \n            const response = await fetch(ajaxurl, {\n                method: 'POST',\n                headers: {\n                    'Content-Type': 'application/x-www-form-urlencoded',\n                },\n                body: new URLSearchParams({\n                    action: 'nuclen_refresh_tasks_data',\n                    nonce: nuclen_tasks.nonce,\n                    page: this.currentPage.toString(),\n                })\n            });\n            \n            const result = await response.json();\n            \n            if (result.success && result.data && result.data.tasks) {\n                // Update all tasks\n                this.updateTasksFromPolling(result.data.tasks);\n                this.showNotice('Tasks refreshed successfully', 'success');\n                \n                // Reset polling timer since we just refreshed\n                this.pollingStartTime = Date.now();\n                if (this.activeTasks.size > 0) {\n                    this.startSmartPolling();\n                }\n            } else {\n                throw new Error(result.data?.message || 'Failed to refresh tasks');\n            }\n        } catch (err) {\n            error('Failed to refresh tasks:', err);\n            this.showNotice('Failed to refresh tasks. Please try again.', 'error');\n        } finally {\n            this.isRefreshing = false;\n            \n            // Remove visual feedback\n            const refreshButton = document.querySelector('.nuclen-refresh-button');\n            if (refreshButton) {\n                refreshButton.classList.remove('is-busy');\n                refreshButton.removeAttribute('disabled');\n            }\n        }\n    }\n\n    private updateTasksTable(tasks: TaskData[]): void {\n        const tbody = document.querySelector('.nuclen-tasks-table tbody');\n        if (!tbody || tasks.length === 0) return;\n\n        // Update each task row\n        tasks.forEach(task => {\n            const row = tbody.querySelector(`tr[data-task-id=\"${task.id}\"]`);\n            if (!row) return;\n\n            // Update status\n            const statusCell = row.querySelector('.column-status');\n            if (statusCell) {\n                statusCell.innerHTML = this.getStatusBadge(task.status);\n            }\n\n            // Update progress\n            const progressCell = row.querySelector('.column-progress');\n            if (progressCell) {\n                progressCell.innerHTML = `\n                    <div class=\"nuclen-progress-container\">\n                        <div class=\"nuclen-progress-bar\">\n                            <div class=\"nuclen-progress-fill\" style=\"width: ${task.progress}%\"></div>\n                        </div>\n                        <span class=\"nuclen-progress-text\">${task.progress}%</span>\n                    </div>\n                `;\n            }\n\n            // Update details\n            const detailsCell = row.querySelector('td:nth-child(7)'); // Details column is now 7th\n            if (detailsCell) {\n                let detailsHTML = task.details;\n                if (task.failed && task.failed > 0) {\n                    detailsHTML += `<br><span class=\"nuclen-error-text\">${task.failed} failed</span>`;\n                }\n                detailsCell.innerHTML = detailsHTML;\n            }\n\n\n            // Update actions based on status\n            this.updateActionButtons(row as HTMLElement, task.status);\n        });\n    }\n\n    private async handleRunTask(event: Event): Promise<void> {\n        event.preventDefault();\n        const button = event.currentTarget as HTMLElement;\n        const taskId = button.getAttribute('data-task-id');\n        \n        if (!taskId || this.isProcessing) return;\n        \n        await this.executeTaskAction('run_task', taskId, button);\n    }\n\n    private async handleCancelTask(event: Event): Promise<void> {\n        event.preventDefault();\n        const button = event.currentTarget as HTMLElement;\n        const taskId = button.getAttribute('data-task-id');\n        \n        if (!taskId || this.isProcessing) return;\n        \n        if (!window.confirm('Are you sure you want to cancel this task?')) {\n            return;\n        }\n        \n        await this.executeTaskAction('cancel_task', taskId, button);\n    }\n\n    private async handleRetryTask(event: Event): Promise<void> {\n        event.preventDefault();\n        const button = event.currentTarget as HTMLElement;\n        const taskId = button.getAttribute('data-task-id');\n        \n        if (!taskId || this.isProcessing) return;\n        \n        if (!window.confirm('Retry this failed task?')) {\n            return;\n        }\n        \n        await this.executeTaskAction('retry_task', taskId, button);\n    }\n\n\n    private async executeTaskAction(action: string, taskId: string, button: HTMLElement): Promise<void> {\n        this.isProcessing = true;\n        const originalText = button.textContent || '';\n        const row = button.closest('tr');\n        \n        try {\n            // Update button state\n            button.classList.add('disabled');\n            button.setAttribute('disabled', 'disabled');\n            \n            if (action === 'run_task') {\n                button.textContent = nuclen_tasks.i18n.processing || 'Processing...';\n            } else if (action === 'cancel_task') {\n                button.textContent = nuclen_tasks.i18n.cancelling || 'Cancelling...';\n            } else if (action === 'retry_task') {\n                button.textContent = 'Retrying...';\n            }\n\n            // Make AJAX request\n            const response = await fetch(ajaxurl, {\n                method: 'POST',\n                headers: {\n                    'Content-Type': 'application/x-www-form-urlencoded',\n                },\n                body: new URLSearchParams({\n                    action: `nuclen_${action}`,\n                    task_id: taskId,\n                    nonce: nuclen_tasks.nonce\n                })\n            });\n\n            const result = await response.json();\n\n            if (result.success) {\n                // Show success message\n                this.showNotice(result.data.message || nuclen_tasks.i18n.success, 'success');\n                \n                // Show additional notice about refreshing\n                if (action === 'run_task') {\n                    setTimeout(() => {\n                        this.showNotice('Task is now processing. Refresh later to see the latest progress.', 'info');\n                    }, 500);\n                }\n                \n                // Update the row status locally\n                if (row) {\n                    // For run_task, immediately show processing status\n                    if (action === 'run_task') {\n                        const statusCell = row.querySelector('.column-status');\n                        if (statusCell) {\n                            statusCell.innerHTML = this.getStatusBadge('processing');\n                        }\n                        // Update action buttons to show spinner\n                        this.updateActionButtons(row as HTMLElement, 'processing');\n                        \n                        // Track as active task and start polling\n                        this.activeTasks.add(taskId);\n                        this.startSmartPolling();\n                    } else if (action === 'cancel_task') {\n                        // For cancel, show cancelled status\n                        const statusCell = row.querySelector('.column-status');\n                        if (statusCell) {\n                            statusCell.innerHTML = this.getStatusBadge('cancelled');\n                        }\n                        // Remove action buttons\n                        const actionsCell = row.querySelector('.column-actions');\n                        if (actionsCell) {\n                            actionsCell.innerHTML = '<span class=\"nuclen-no-actions\">—</span>';\n                        }\n                        \n                        // Remove from active tasks\n                        this.activeTasks.delete(taskId);\n                    } else if (action === 'retry_task') {\n                        // For retry, show pending status\n                        const statusCell = row.querySelector('.column-status');\n                        if (statusCell) {\n                            statusCell.innerHTML = this.getStatusBadge('pending');\n                        }\n                        // Update action buttons to pending state\n                        this.updateActionButtons(row as HTMLElement, 'pending');\n                        \n                        // Track as active task and start polling\n                        this.activeTasks.add(taskId);\n                        this.startSmartPolling();\n                    }\n                }\n            } else {\n                // Use generic error message for user display\n                const errorMessage = nuclen_tasks.i18n.error || 'An error occurred. Please try again.';\n                throw new Error(errorMessage);\n            }\n\n        } catch (err) {\n            error('Task action failed:', err);\n            // Always show generic error message to users\n            const userMessage = nuclen_tasks.i18n.error || 'An error occurred. Please try again.';\n            this.showNotice(userMessage, 'error');\n            \n            // Restore button state\n            button.textContent = originalText;\n            button.classList.remove('disabled');\n            button.removeAttribute('disabled');\n        } finally {\n            this.isProcessing = false;\n        }\n    }\n\n    private getStatusBadge(status: string): string {\n        const badges: Record<string, string> = {\n            'pending': '<span class=\"nuclen-badge nuclen-badge-warning\">Pending</span>',\n            'scheduled': '<span class=\"nuclen-badge nuclen-badge-warning\">Scheduled</span>',\n            'processing': '<span class=\"nuclen-badge nuclen-badge-info\">Processing</span>',\n            'completed': '<span class=\"nuclen-badge nuclen-badge-success\">Completed</span>',\n            'completed_with_errors': '<span class=\"nuclen-badge nuclen-badge-warning\">Completed with Errors</span>',\n            'failed': '<span class=\"nuclen-badge nuclen-badge-error\">Failed</span>',\n            'cancelled': '<span class=\"nuclen-badge nuclen-badge-default\">Cancelled</span>'\n        };\n        \n        return badges[status] || `<span class=\"nuclen-badge nuclen-badge-default\">${status}</span>`;\n    }\n\n    private updateActionButtons(row: HTMLElement, status: string): void {\n        const actionsCell = row.querySelector('.column-actions');\n        if (!actionsCell) return;\n\n        // Clear existing actions\n        actionsCell.innerHTML = '';\n\n        const taskId = row.getAttribute('data-task-id');\n        if (!taskId) return;\n\n        if (status === 'pending' || status === 'scheduled') {\n            actionsCell.innerHTML = `\n                <button class=\"button button-small nuclen-run-now\" data-task-id=\"${taskId}\">\n                    Run Now\n                </button>\n                <button class=\"button button-small nuclen-cancel\" data-task-id=\"${taskId}\">\n                    Cancel\n                </button>\n            `;\n            \n            // Re-attach event handlers\n            actionsCell.querySelector('.nuclen-run-now')?.addEventListener('click', (e) => this.handleRunTask(e));\n            actionsCell.querySelector('.nuclen-cancel')?.addEventListener('click', (e) => this.handleCancelTask(e));\n        } else if (status === 'processing') {\n            // Get task age from row\n            const createdAtText = row.querySelector('td:nth-child(1)')?.textContent || '';\n            let showForceComplete = false;\n            \n            // Simple check: if the task shows a time that's likely old, show force complete\n            // This is a fallback since we can't easily parse the formatted date\n            actionsCell.innerHTML = `\n                <span class=\"spinner is-active\"></span>\n                <button class=\"button button-small nuclen-cancel\" data-task-id=\"${taskId}\">\n                    Cancel\n                </button>\n            `;\n            \n            // Re-attach cancel event handler\n            actionsCell.querySelector('.nuclen-cancel')?.addEventListener('click', (e) => this.handleCancelTask(e));\n            \n            // Note: Force complete button is added by PHP template based on actual task age\n        } else if (status === 'failed' || status === 'cancelled') {\n            actionsCell.innerHTML = `\n                <button class=\"button button-small nuclen-retry\" data-task-id=\"${taskId}\">\n                    Retry\n                </button>\n            `;\n            \n            // Re-attach retry event handler\n            actionsCell.querySelector('.nuclen-retry')?.addEventListener('click', (e) => this.handleRetryTask(e));\n        } else {\n            actionsCell.innerHTML = '<span class=\"nuclen-no-actions\">—</span>';\n        }\n    }\n\n    private showNotice(message: string, type: 'success' | 'error' | 'info' = 'info'): void {\n        // Check if there's an existing notice container\n        let noticeContainer = document.querySelector('.nuclen-tasks-notices');\n        if (!noticeContainer) {\n            // Create notice container\n            noticeContainer = document.createElement('div');\n            noticeContainer.className = 'nuclen-tasks-notices';\n            const pageTitle = document.querySelector('.wrap h1');\n            if (pageTitle) {\n                pageTitle.insertAdjacentElement('afterend', noticeContainer);\n            }\n        }\n\n        // Create notice element\n        const notice = document.createElement('div');\n        notice.className = `notice notice-${type} is-dismissible`;\n        notice.innerHTML = `\n            <p>${message}</p>\n            <button type=\"button\" class=\"notice-dismiss\">\n                <span class=\"screen-reader-text\">Dismiss this notice.</span>\n            </button>\n        `;\n\n        // Add to container\n        noticeContainer.appendChild(notice);\n\n        // Handle dismiss\n        notice.querySelector('.notice-dismiss')?.addEventListener('click', () => {\n            notice.remove();\n        });\n\n        // Auto-dismiss after 5 seconds\n        setTimeout(() => {\n            notice.remove();\n        }, 5000);\n    }\n\n    \n    private async checkRecentCompletions(): Promise<void> {\n        try {\n            const response = await fetch(ajaxurl, {\n                method: 'POST',\n                headers: {\n                    'Content-Type': 'application/x-www-form-urlencoded',\n                },\n                body: new URLSearchParams({\n                    action: 'nuclen_get_recent_completions',\n                    nonce: nuclen_tasks.nonce\n                })\n            });\n\n            const result = await response.json();\n            \n            if (result.success && result.data && result.data.length > 0) {\n                // Show notifications for recent completions\n                result.data.forEach((completion: any) => {\n                    // let message: string;\n                    // let type: 'success' | 'error' | 'info';\n                    \n                    if (completion.status === 'completed') {\n                        // message = `Generation ${completion.task_id} completed successfully!`;\n                        // type = 'success';\n                    } else if (completion.status === 'completed_with_errors') {\n                        // const failCount = completion.fail_count || 'some';\n                        // message = `Generation ${completion.task_id} completed with ${failCount} errors. Check individual posts for details.`;\n                        // type = 'info';\n                    } else if (completion.status === 'failed') {\n                        // message = `Generation ${completion.task_id} failed.`;\n                        // type = 'error';\n                    } else {\n                        return; // Skip unknown statuses\n                    }\n                    \n                    // Disabled for now - will be re-enabled later\n                    // this.showNotice(message, type);\n                });\n            }\n        } catch (err) {\n            error('Failed to check recent completions:', err);\n        }\n    }\n    \n    private createPollingIndicator(): void {\n        // Create the polling status indicator\n        const indicator = document.createElement('div');\n        indicator.className = 'nuclen-polling-indicator';\n        indicator.innerHTML = `\n            <span class=\"nuclen-polling-icon\">\n                <span class=\"dashicons dashicons-update\"></span>\n            </span>\n            <span class=\"nuclen-polling-text\">Auto-refresh: <span class=\"status\">Inactive</span></span>\n            <span class=\"nuclen-polling-countdown\"></span>\n        `;\n        \n        // Find the refresh button and insert indicator next to it\n        const refreshButton = document.querySelector('.nuclen-refresh-button');\n        \n        if (refreshButton && refreshButton.parentNode) {\n            refreshButton.parentNode.insertBefore(indicator, refreshButton.nextSibling);\n            this.pollingIndicator = indicator;\n        } else {\n            // Fallback: insert after the page title\n            const pageTitle = document.querySelector('.wrap h1');\n            if (pageTitle) {\n                pageTitle.appendChild(indicator);\n                this.pollingIndicator = indicator;\n            }\n        }\n        \n        // Create notification banner for auto-refresh\n        this.createAutoRefreshBanner();\n    }\n    \n    private createAutoRefreshBanner(): void {\n        const banner = document.createElement('div');\n        banner.className = 'nuclen-auto-refresh-banner';\n        banner.innerHTML = `\n            <span class=\"dashicons dashicons-update\"></span>\n            <span>Auto-refresh active</span>\n        `;\n        document.body.appendChild(banner);\n        this.autoRefreshBanner = banner;\n    }\n    \n    private updatePollingIndicator(active: boolean, interval?: number): void {\n        if (!this.pollingIndicator) return;\n        \n        const statusEl = this.pollingIndicator.querySelector('.status') as HTMLElement;\n        const iconEl = this.pollingIndicator.querySelector('.nuclen-polling-icon') as HTMLElement;\n        const countdownEl = this.pollingIndicator.querySelector('.nuclen-polling-countdown') as HTMLElement;\n        \n        if (active) {\n            this.pollingIndicator.classList.add('active');\n            statusEl.textContent = `Active (${this.activeTasks.size} task${this.activeTasks.size !== 1 ? 's' : ''})`;\n            iconEl.classList.add('spin');\n            \n            if (interval) {\n                const seconds = Math.floor(interval / 1000);\n                countdownEl.textContent = `Next refresh in ${seconds}s`;\n            }\n            \n            // Show the auto-refresh banner briefly when first activated\n            if (this.autoRefreshBanner && !this.pollingIndicator.classList.contains('active')) {\n                this.autoRefreshBanner.classList.add('show');\n                // Auto-hide after 3 seconds\n                setTimeout(() => {\n                    if (this.autoRefreshBanner) {\n                        this.autoRefreshBanner.classList.remove('show');\n                    }\n                }, 3000);\n            }\n        } else {\n            this.pollingIndicator.classList.remove('active');\n            statusEl.textContent = 'Inactive';\n            iconEl.classList.remove('spin');\n            countdownEl.textContent = '';\n            \n            // Hide the auto-refresh banner\n            if (this.autoRefreshBanner) {\n                this.autoRefreshBanner.classList.remove('show');\n            }\n        }\n    }\n    \n    private startCountdown(): void {\n        // Clear any existing countdown\n        if (this.countdownInterval) {\n            clearInterval(this.countdownInterval);\n        }\n        \n        this.countdownInterval = window.setInterval(() => {\n            const remaining = Math.max(0, Math.floor((this.nextPollTime - Date.now()) / 1000));\n            const countdownEl = this.pollingIndicator?.querySelector('.nuclen-polling-countdown') as HTMLElement;\n            \n            if (countdownEl) {\n                if (remaining > 0) {\n                    countdownEl.textContent = `Next refresh in ${remaining}s`;\n                } else {\n                    countdownEl.textContent = 'Refreshing...';\n                }\n            }\n            \n            if (remaining <= 0 && this.countdownInterval) {\n                clearInterval(this.countdownInterval);\n                this.countdownInterval = null;\n            }\n        }, 1000);\n    }\n}\n\n// Initialize when DOM is ready\ndocument.addEventListener('DOMContentLoaded', () => {\n    try {\n        new TasksManager();\n    } catch (error) {\n        // Silently fail\n    }\n});\n\n// Export for testing\nexport default TasksManager;"],"names":["TasksManager","__publicField","log","err","error","row","taskId","statusCell","statusText","_a","progressCell","detailsCell","progress","progressText","match","_b","_c","_d","badgeHtml","detailsHtml","elapsedTime","interval","config","response","result","newTasks","updatedTasks","MAX_STORED_TASKS","tasksToRemove","task","id","removeCount","newTask","oldTask","indicator","pageTitle","button","e","refreshLink","urlParams","refreshButton","tasks","tbody","detailsHTML","event","action","originalText","actionsCell","errorMessage","userMessage","status","_e","message","type","noticeContainer","notice","completion","banner","active","statusEl","iconEl","countdownEl","seconds","remaining"],"mappings":"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"}